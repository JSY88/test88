<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì½ê¸° í›ˆë ¨</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600&family=IBM+Plex+Mono:wght@400;600&display=swap');

/* â”€â”€ í…Œë§ˆ ë³€ìˆ˜ â”€â”€ */
:root{
  --bg:#0e0e11;--sf:#16161b;--sf2:#1e1e26;--bd:#2c2c3a;
  --tx:#dddbe8;--dim:#6a6878;--ac:#a78bfa;--ac-dim:#3d2f7a;
  --green:#6ee7b7;--red:#f87171;--yellow:#fbbf24;
}
[data-theme="light"]{
  --bg:#f4f3f0;--sf:#ffffff;--sf2:#ededea;--bd:#d8d6cf;
  --tx:#1a1916;--dim:#8a8880;--ac:#7c3aed;--ac-dim:#ede9fe;
  --green:#059669;--red:#dc2626;--yellow:#d97706;
}
/* â”€â”€ ì´ë¶ í‘ë°± í…Œë§ˆ â”€â”€ */
[data-theme="ebook"]{
  --bg:#ffffff;--sf:#ffffff;--sf2:#f0f0f0;--bd:#cccccc;
  --tx:#000000;--dim:#555555;--ac:#000000;--ac-dim:#e8e8e8;
  --green:#000000;--red:#000000;--yellow:#000000;
}
[data-theme="ebook"] *{font-family:'Noto Serif KR',serif!important}
[data-theme="ebook"] .sp{display:none}
[data-theme="ebook"] .ul{display:none}
[data-theme="ebook"] .delay-dot{display:none}
[data-theme="ebook"] .tok.going{opacity:0.08}
[data-theme="ebook"] .sdot{background:#aaa}
[data-theme="ebook"] .sdot.hit{background:#000}
[data-theme="ebook"] .sdot.miss{background:#666}
[data-theme="ebook"] .pf{background:#000}
[data-theme="ebook"] .ob.correct{background:#e8e8e8;border-color:#000;color:#000}
[data-theme="ebook"] .ob.wrong{background:#e8e8e8;border-color:#555;color:#555}
[data-theme="ebook"] .toast{border-radius:4px}
[data-theme="ebook"] .judge-btn.chosen-c,[data-theme="ebook"] .judge-btn.chosen-w{filter:none}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100dvh;overflow:hidden;background:var(--bg);color:var(--tx);font-family:'Noto Serif KR',serif;transition:background .2s,color .2s}
.screen{display:none;flex-direction:column;height:100dvh}.screen.active{display:flex}

/* COMMON */
.card{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:16px;margin-bottom:12px}
.card-title{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:11px}
.fl{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:6px}
.fw{margin-bottom:11px}
.row2{display:flex;gap:10px}.row2 .fw{flex:1}
input[type=text],input[type=password],input[type=number],textarea,select{
  width:100%;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);
  padding:9px 11px;border-radius:9px;font-size:13px;outline:none;transition:border-color .15s;
  font-family:'IBM Plex Mono',monospace;-webkit-appearance:none}
input:focus,textarea:focus,select:focus{border-color:var(--ac)}
textarea{resize:vertical;min-height:64px;line-height:1.5;font-family:'Noto Serif KR',serif;font-size:13px}
select{appearance:none;cursor:pointer}
.tabs{display:flex;gap:5px}
.tab{flex:1;padding:8px 4px;border:1.5px solid var(--bd);border-radius:8px;background:none;color:var(--dim);
  font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;text-align:center;transition:all .15s}
.tab.active{border-color:var(--ac);color:var(--ac);background:var(--ac-dim)}
.btn-p{width:100%;background:var(--ac);color:#fff;border:none;padding:14px;border-radius:11px;
  font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:opacity .2s,transform .1s}
.btn-p:active{transform:scale(.98);opacity:.85}.btn-p:disabled{opacity:.35;cursor:not-allowed}
.btn-g{background:none;border:1px solid var(--bd);color:var(--dim);padding:7px 13px;border-radius:8px;
  font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .15s}
.btn-g:hover{border-color:var(--ac);color:var(--ac)}
.btn-ic{background:none;border:none;color:var(--dim);cursor:pointer;padding:4px 7px;font-size:15px;line-height:1;touch-action:manipulation}
.sd{font-size:12px;color:var(--dim);line-height:1.5;margin-top:4px}
.nst{display:flex;align-items:center;gap:6px}
.nb{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);width:36px;height:36px;
  border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
.nv{font-family:'IBM Plex Mono',monospace;font-size:15px;color:var(--ac);min-width:44px;text-align:center}
.ml{display:flex;flex-direction:column;gap:5px;margin-bottom:9px}
.mc{display:flex;align-items:center;background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:8px 11px;gap:7px}
.mc-n{font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1;word-break:break-all}
.cb{background:none;border:none;color:var(--dim);cursor:pointer;font-size:13px;padding:3px 7px;border-radius:4px;touch-action:manipulation}
.cb:hover{color:var(--red)}
.ar{display:flex;gap:7px}.ar input{flex:1}
.ab{background:var(--sf2);border:1px solid var(--ac);color:var(--ac);padding:8px 13px;
  border-radius:8px;font-family:'IBM Plex Mono',monospace;font-size:12px;cursor:pointer;white-space:nowrap;touch-action:manipulation}

/* AUTH BAR */
.auth-bar{display:flex;align-items:center;gap:8px;padding:7px 16px;
  background:var(--sf);border-bottom:1px solid var(--bd);flex-shrink:0}
.auth-info{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);flex:1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.auth-info span{color:var(--ac)}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--bd);flex-shrink:0;transition:background .3s}
.sync-dot.ok{background:var(--green)}.sync-dot.busy{background:var(--yellow);animation:pulse2 1s infinite}
.sync-dot.err{background:var(--red)}
@keyframes pulse2{0%,100%{opacity:.4}50%{opacity:1}}
.theme-btn{background:none;border:1px solid var(--bd);color:var(--dim);padding:4px 9px;font-size:15px;
  border-radius:7px;cursor:pointer;flex-shrink:0;touch-action:manipulation}
.auth-btn{background:none;border:1px solid var(--bd);color:var(--dim);padding:5px 10px;
  border-radius:7px;font-family:'IBM Plex Mono',monospace;font-size:10px;cursor:pointer;
  transition:all .15s;white-space:nowrap;flex-shrink:0;touch-action:manipulation}
.auth-btn:hover{border-color:var(--ac);color:var(--ac)}
.auth-btn.login{border-color:var(--ac);color:var(--ac)}

/* HOME */
#home{overflow-y:auto}
.hh{padding:24px 18px 0;background:radial-gradient(ellipse 90% 60% at 50% 0%,#1a1040 0%,var(--bg) 70%);flex-shrink:0}
[data-theme="light"] .hh{background:radial-gradient(ellipse 90% 60% at 50% 0%,#ede9fe 0%,var(--bg) 70%)}
.eyebrow{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:4px;color:var(--ac);text-transform:uppercase;margin-bottom:7px}
.ht{font-size:21px;font-weight:600;margin-bottom:14px}
.hn{display:flex;border-bottom:1px solid var(--bd);margin:0 -18px;padding:0 18px;overflow-x:auto}
.hnb{flex:1;min-width:60px;padding:9px 2px;background:none;border:none;color:var(--dim);
  font-family:'IBM Plex Mono',monospace;font-size:10px;cursor:pointer;
  border-bottom:2px solid transparent;transition:all .15s;text-align:center;white-space:nowrap}
.hnb.active{color:var(--ac);border-bottom-color:var(--ac)}
.htab{display:none;padding:14px 18px 80px;flex-direction:column}
.htab.active{display:flex}

/* LIBRARY */
.fs{margin-bottom:12px}
.fhd{display:flex;align-items:center;gap:7px;padding:10px 11px;
  background:var(--sf2);border:1px solid var(--bd);border-radius:10px;
  cursor:pointer;margin-bottom:4px;user-select:none;-webkit-user-select:none}
.fch{font-size:10px;color:var(--dim);transition:transform .2s;flex-shrink:0}
.fch.open{transform:rotate(90deg)}
.flb{font-size:14px;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fmeta{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dim);flex-shrink:0}
.fb{display:none;padding-left:6px}.fb.open{display:block}
.wi{display:flex;align-items:center;gap:7px;background:var(--sf2);border:1px solid var(--bd);
  border-radius:10px;padding:10px 11px;transition:border-color .15s;margin-bottom:4px}
.wi:hover{border-color:var(--ac)}
.wi-info{flex:1;min-width:0;cursor:pointer}
.wi-name{font-size:13px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wi-meta{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dim)}
.wa{display:flex;gap:2px;flex-shrink:0;align-items:center}
.wbtn{background:none;border:none;cursor:pointer;font-size:13px;color:var(--dim);
  padding:6px 7px;border-radius:6px;touch-action:manipulation;min-width:32px;min-height:32px;
  display:flex;align-items:center;justify-content:center}
.wbtn:hover{color:var(--tx)}.wbtn.del:hover{color:var(--red)}
.wbtn.st{background:var(--ac);color:#fff;font-size:11px;padding:6px 10px;
  border-radius:7px;font-family:'IBM Plex Mono',monospace;font-weight:600;border:none}
.es{text-align:center;color:var(--dim);font-size:13px;padding:16px 0;line-height:1.7}
/* ì´ì–´í•˜ê¸° ë°°ì§€ */
.resume-badge{font-family:'IBM Plex Mono',monospace;font-size:9px;background:var(--ac-dim);
  color:var(--ac);border-radius:4px;padding:1px 5px;margin-left:6px}

/* WB DETAIL */
#wbDetail{overflow-y:auto}
.dh{display:flex;align-items:center;gap:7px;padding:12px 14px;border-bottom:1px solid var(--bd);flex-shrink:0}
.dt{font-size:15px;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sc-card{background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:11px 13px;margin-bottom:6px}
.scn{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:3px}
.sct{font-size:13px;line-height:1.6;margin-bottom:4px}
.scq{font-size:12px;color:var(--ac);font-family:'IBM Plex Mono',monospace}
.sctype{font-size:10px;font-family:'IBM Plex Mono',monospace;margin-left:6px;
  background:var(--sf);border:1px solid var(--bd);border-radius:4px;padding:1px 5px;color:var(--dim)}

/* TRAINING */
#training{overflow:hidden}
.th{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-bottom:1px solid var(--bd);flex-shrink:0}
.tl{display:flex;flex-direction:column;gap:3px}
.tm{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim)}
.tm span{color:var(--ac)}
.sd-row{display:flex;gap:4px;align-items:center}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--bd);transition:background .2s}
.sdot.hit{background:var(--green)}.sdot.miss{background:var(--red)}
.pb{height:2px;background:var(--bd);flex-shrink:0}
.pf{height:100%;background:var(--ac);transition:width .4s;width:0%}
.fa{flex:1;display:flex;align-items:center;justify-content:center;padding:20px 18px;overflow:hidden;position:relative}
.sw{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center}
.st{font-size:18px;line-height:1.9;text-align:center;width:100%;word-break:keep-all;white-space:normal;overflow-wrap:break-word}
.ul{height:2px;border-radius:1px;margin-top:8px;background:var(--ac);opacity:0;transition:opacity .3s;width:60%}
.ul.waiting{opacity:.35}.ul.active{opacity:.5}
.delay-dot{position:absolute;bottom:calc(50% - 36px);left:50%;transform:translateX(-50%);
  width:9px;height:9px;border-radius:50%;background:var(--ac);opacity:0}
.delay-dot.show{opacity:.6;animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:.35}50%{transform:scale(1.7);opacity:.85}}
.tok{display:inline;transition:opacity 0.25s ease-in-out}
.tok.going{opacity:0.05}.tok.gone{opacity:0;transition:none}
.tf{flex-shrink:0;padding:9px 12px 16px;border-top:1px solid var(--bd)}
.tf-top{display:flex;align-items:center;justify-content:center;gap:9px;margin-bottom:8px}
.spd-btn{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);padding:9px 16px;
  border-radius:8px;font-family:'IBM Plex Mono',monospace;font-size:12px;cursor:pointer;
  transition:all .15s;touch-action:manipulation;min-height:40px}
.spd-btn:hover{border-color:var(--ac);color:var(--ac)}
.spd-val{font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--ac);min-width:70px;text-align:center}
.nxbtn{display:none}

/* QUESTION */
#question{overflow:hidden}
.qb{flex:1;padding:14px 16px;display:flex;flex-direction:column;gap:7px;overflow-y:auto;align-items:center}
.qt{font-size:16px;line-height:1.55;font-weight:600;text-align:center;width:100%;max-width:540px}
.ow{width:100%;max-width:540px;display:flex;flex-direction:column;gap:7px}
/* ê°ê´€ì‹ ë³´ê¸° */
.ob{width:100%;background:var(--sf);border:1.5px solid var(--bd);color:var(--tx);
  padding:12px 14px;border-radius:10px;font-family:'Noto Serif KR',serif;font-size:14px;
  text-align:center;cursor:pointer;transition:all .15s;line-height:1.4;touch-action:manipulation;
  min-height:46px}
.ob:hover:not(:disabled){border-color:var(--ac)}
.ob.correct{background:rgba(110,231,183,.1);border-color:var(--green);color:var(--green)}
.ob.wrong{background:rgba(248,113,113,.1);border-color:var(--red);color:var(--red)}
.ob:disabled{cursor:default}
/* ì£¼ê´€ì‹ ì…ë ¥ */
.subj-wrap{width:100%;max-width:540px;display:flex;flex-direction:column;gap:7px}
.subj-input{width:100%;background:var(--sf2);border:1.5px solid var(--bd);color:var(--tx);
  padding:12px 14px;border-radius:10px;font-family:'Noto Serif KR',serif;font-size:15px;
  text-align:center;outline:none;transition:border-color .15s}
.subj-input:focus{border-color:var(--ac)}
.subj-submit{width:100%;background:var(--ac);color:#fff;border:none;padding:12px;border-radius:10px;
  font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;cursor:pointer;touch-action:manipulation}
.subj-submit:disabled{opacity:.4;cursor:default}
/* ëª¨ë²” ë‹µì•ˆ */
.subj-reveal{width:100%;max-width:540px;background:var(--sf2);border:1px solid var(--bd);
  border-radius:10px;padding:12px 14px;font-size:14px;text-align:center;color:var(--dim);
  display:none;line-height:1.6}
.subj-reveal.show{display:block}
.subj-reveal strong{color:var(--ac);font-size:16px}
/* ì£¼ê´€ì‹ ì •ì˜¤ë‹µ ì±„ì  ë²„íŠ¼ */
.judge-wrap{width:100%;max-width:540px;display:none;gap:10px}
.judge-wrap.show{display:flex}
.judge-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
  padding:16px 10px;border-radius:13px;border:2px solid;font-family:'IBM Plex Mono',monospace;
  font-size:15px;font-weight:700;cursor:pointer;transition:all .15s;touch-action:manipulation;
  letter-spacing:.5px;min-height:56px}
.judge-btn.wrong{background:rgba(248,113,113,.08);border-color:var(--red);color:var(--red)}
.judge-btn.correct{background:rgba(110,231,183,.08);border-color:var(--green);color:var(--green)}
.judge-btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
.judge-btn:active{transform:scale(.97)}
.judge-btn.chosen-w{background:rgba(248,113,113,.2);border-color:var(--red)}
.judge-btn.chosen-c{background:rgba(110,231,183,.2);border-color:var(--green)}
.judge-key{font-size:10px;opacity:.55;border:1px solid currentColor;border-radius:4px;padding:1px 5px;font-weight:400}
/* skip/feedback */
.skip-wrap{width:100%;max-width:540px}
.skip-btn{width:100%;background:none;border:1.5px solid var(--bd);color:var(--dim);
  padding:10px;border-radius:10px;font-family:'IBM Plex Mono',monospace;font-size:11px;
  cursor:pointer;text-align:center;transition:all .15s;letter-spacing:1px;touch-action:manipulation;min-height:40px}
.skip-btn:hover:not(:disabled){border-color:var(--yellow);color:var(--yellow)}
.skip-btn:disabled{opacity:.3;cursor:default}
.qfb{margin-top:2px;padding:9px 12px;border-radius:9px;font-family:'IBM Plex Mono',monospace;
  font-size:12px;display:none;width:100%;max-width:540px;text-align:center}
.qfb.show{display:block}
.qfb.ok{background:rgba(110,231,183,.12);color:var(--green)}
.qfb.ng{background:rgba(248,113,113,.12);color:var(--red)}
.qfb.sk{background:rgba(251,191,36,.1);color:var(--yellow)}
.qft{padding:9px 16px 20px;flex-shrink:0}
.qnb{width:100%;background:var(--ac);color:#fff;border:none;padding:13px;border-radius:11px;
  font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;cursor:pointer;
  display:none;text-align:center;touch-action:manipulation}
.qnb.show{display:block}

/* RESULT */
#result{align-items:center;justify-content:center;gap:18px;padding:32px 20px;overflow-y:auto}
.re{font-size:50px}.rh{font-size:21px;font-weight:600;text-align:center}
.sg{width:100%;max-width:320px;display:grid;grid-template-columns:1fr 1fr;gap:7px}
.sc2{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:12px;text-align:center}
.sv{font-family:'IBM Plex Mono',monospace;font-size:18px;color:var(--ac);margin-bottom:2px}
.sl2{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase}
.rb{display:flex;flex-direction:column;gap:7px;width:100%;max-width:320px}
.rbtn{padding:13px;border-radius:11px;font-family:'IBM Plex Mono',monospace;font-size:12px;
  cursor:pointer;text-align:center;border:none;letter-spacing:1px;touch-action:manipulation}
.rbtn.pr{background:var(--ac);color:#fff;font-weight:700}
.rbtn.se{background:var(--sf);border:1px solid var(--bd);color:var(--dim)}

/* TOGGLE SWITCH */
.toggle-sw{position:relative;display:inline-block;width:44px;height:26px;flex-shrink:0}
.toggle-sw input{opacity:0;width:0;height:0;position:absolute}
.toggle-knob{position:absolute;cursor:pointer;inset:0;background:var(--bd);border-radius:26px;transition:.2s}
.toggle-knob:before{content:'';position:absolute;width:20px;height:20px;left:3px;top:3px;
  background:#fff;border-radius:50%;transition:.2s}
.toggle-sw input:checked+.toggle-knob{background:var(--ac)}
.toggle-sw input:checked+.toggle-knob:before{transform:translateX(18px)}
[data-theme="ebook"] .toggle-knob{background:var(--bd)}
[data-theme="ebook"] .toggle-sw input:checked+.toggle-knob{background:#000}

/* TOAST */
.toast{position:fixed;bottom:72px;left:50%;transform:translateX(-50%);
  background:var(--sf2);border:1px solid var(--bd);color:var(--tx);
  padding:8px 15px;border-radius:15px;font-family:'IBM Plex Mono',monospace;font-size:11px;
  opacity:0;pointer-events:none;transition:opacity .25s;white-space:nowrap;z-index:200;
  max-width:90vw;text-align:center}
.toast.show{opacity:1}
.toast.up{color:var(--green);border-color:var(--green)}
.toast.dn{color:var(--red);border-color:var(--red)}

/* HELP */
.help-key-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--dim);line-height:1.5}
.help-key-row span{color:var(--tx)}
kbd{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;
  background:var(--sf2);border:1px solid var(--bd);border-radius:5px;
  padding:2px 7px;color:var(--ac);white-space:nowrap}

/* MODAL */
.mbg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;align-items:flex-end}
.mbg.show{display:flex}
.md{background:var(--sf);border:1px solid var(--bd);border-radius:16px 16px 0 0;
  width:100%;padding:20px 18px 32px;display:flex;flex-direction:column;gap:11px;
  max-height:80dvh;overflow-y:auto}
.md h3{font-size:15px;font-weight:600}
.md p{font-size:13px;color:var(--dim);line-height:1.5}
.mdb{display:flex;gap:7px;margin-top:2px;flex-wrap:wrap}
.mdb button{flex:1;min-width:80px;padding:12px;border-radius:9px;font-family:'IBM Plex Mono',monospace;
  font-size:12px;cursor:pointer;border:none;font-weight:600;touch-action:manipulation}
.m-ok{background:var(--ac);color:#fff}
.m-del{background:rgba(248,113,113,.15);color:var(--red);border:1px solid var(--red)!important}
.m-cancel{background:var(--sf2);color:var(--dim)}
.m-warn{background:rgba(251,191,36,.15);color:var(--yellow);border:1px solid var(--yellow)!important}
</style>
</head>
<body>

<!-- HOME -->
<div id="home" class="screen active">
  <div class="auth-bar">
    <div class="auth-info" id="authInfo">ë¡œê·¸ì¸í•˜ë©´ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤</div>
    <div class="sync-dot" id="syncDot"></div>
    <button class="theme-btn" id="themeBtn" title="í…Œë§ˆ ì „í™˜">ğŸŒ™</button>
    <button class="auth-btn login" id="authBtn">Google ë¡œê·¸ì¸</button>
  </div>
  <div class="hh">
    <div class="eyebrow">Text Fading Trainer</div>
    <div class="ht">ì½ê¸° ìœ ì°½ì„± í›ˆë ¨</div>
    <div class="hn">
      <button class="hnb active" data-nav="lib">ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
      <button class="hnb" data-nav="imp">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="hnb" data-nav="cfg">âš™ ì„¤ì •</button>
    </div>
  </div>
  <div class="htab active" id="tab-lib"><div id="libRoot"></div></div>


  <!-- JSON ë¶ˆëŸ¬ì˜¤ê¸° -->
  <div class="htab" id="tab-imp">
    <div class="card">
      <div class="card-title">JSON ë¶ˆëŸ¬ì˜¤ê¸°</div>
      <p style="font-size:12px;color:var(--dim);line-height:1.7;margin-bottom:10px">ì•„ë˜ ë‘ í˜•ì‹ì„ ëª¨ë‘ ì§€ì›í•©ë‹ˆë‹¤. í•œ íŒŒì¼ì— í˜¼í•© ê°€ëŠ¥.</p>
      <!-- ê°ê´€ì‹ -->
      <div class="fl" style="margin-bottom:5px">ê°ê´€ì‹ (options + answer)</div>
      <pre style="background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--dim);overflow-x:auto;margin-bottom:10px;white-space:pre-wrap">[{
  "text": "ì§€ë¬¸ ë‚´ìš©",
  "question": "ì§ˆë¬¸?",
  "options": ["ë³´ê¸°1","ë³´ê¸°2","ë³´ê¸°3","ë³´ê¸°4"],
  "answer": 0
}]</pre>
      <!-- ì£¼ê´€ì‹ -->
      <div class="fl" style="margin-bottom:5px">ì£¼ê´€ì‹ (type: "short", answer: "ì •ë‹µ ë¬¸ìì—´")</div>
      <pre style="background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--dim);overflow-x:auto;margin-bottom:12px;white-space:pre-wrap">[{
  "text": "ì§€ë¬¸ ë‚´ìš©",
  "question": "ì§ˆë¬¸?",
  "type": "short",
  "answer": "ëª¨ë²” ë‹µì•ˆ í…ìŠ¤íŠ¸"
}]</pre>
      <div class="fw"><div class="fl">í´ë”</div><select id="impFolderSelect"></select></div>
      <div class="fw"><div class="fl">ë¬¸ì œì§‘ ì´ë¦„</div><input type="text" id="impWbName" placeholder="ë¶ˆëŸ¬ì˜¨ ë¬¸ì œì§‘ ì´ë¦„"></div>
      <div style="display:flex;gap:7px">
        <button class="btn-p" id="importFileBtn" style="flex:1">ğŸ“‚ íŒŒì¼ ì„ íƒ</button>
        <button class="btn-p" id="importPasteBtn" style="flex:1;background:var(--sf2);color:var(--tx);border:1px solid var(--bd)">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </div>
    <div class="card" style="display:none" id="impPreviewCard">
      <div class="card-title">ë¯¸ë¦¬ë³´ê¸°</div>
      <div id="impPreview"></div>
      <button class="btn-p" id="impSaveBtn" style="margin-top:4px">ì´ ë¬¸ì œì§‘ ì €ì¥ â†’</button>
    </div>
    <div style="height:32px"></div>
  </div>

  <!-- ì„¤ì • -->
  <div class="htab" id="tab-cfg">
    <div class="card" style="margin-bottom:12px">
      <div class="card-title">í™”ë©´ ëª¨ë“œ</div>
      <div class="tabs" style="margin-bottom:0">
        <button class="tab active" data-tm="dark">ğŸŒ‘ ë‹¤í¬</button>
        <button class="tab" data-tm="light">â˜€ï¸ ë¼ì´íŠ¸</button>
        <button class="tab" data-tm="ebook">ğŸ“– ì´ë¶</button>
      </div>
      <div class="sd" id="themeDesc" style="margin-top:8px">OLED í™”ë©´ì— ìµœì í™”ëœ ì–´ë‘ìš´ ë°°ê²½</div>
    </div>
    <div class="card" id="nbackCard">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0">
        <div>
          <div class="card-title" style="margin-bottom:3px">N-Back ëª¨ë“œ</div>
          <div class="sd" id="nbackDesc">í˜„ì¬ ì§€ë¬¸ì´ ì•„ë‹Œ Në²ˆì§¸ ì „ ì§€ë¬¸ì— ëŒ€í•œ ë¬¸ì œë¥¼ í’‰ë‹ˆë‹¤</div>
        </div>
        <label class="toggle-sw" title="N-Back ì¼œê¸°/ë„ê¸°">
          <input type="checkbox" id="nbackToggle">
          <span class="toggle-knob"></span>
        </label>
      </div>
      <div id="nbackNWrap" style="display:none;margin-top:12px;border-top:1px solid var(--bd);padding-top:12px">
        <div class="fw" style="margin-bottom:0"><div class="fl">N ê°’ (ëª‡ ë²ˆì§¸ ì „ ì§€ë¬¸)</div>
          <div class="nst">
            <button class="nb" data-cfg="nbackN" data-d="-1" data-min="1" data-max="9">âˆ’</button>
            <div class="nv" id="val-nbackN">2</div>
            <button class="nb" data-cfg="nbackN" data-d="1" data-min="1" data-max="9">+</button>
            <span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ë‹¨ê³„ ì „</span>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">í›ˆë ¨ ì†ë„ ëª¨ë“œ</div>
      <div class="tabs" style="margin-bottom:9px">
        <button class="tab active" data-sm="adaptive">ì ì‘í˜•</button>
        <button class="tab" data-sm="manual">ìˆ˜ë™</button>
      </div>
      <div class="sd" id="speedModeDesc">ì •ë‹µ/ì˜¤ë‹µ ì—°ì†ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤</div>
    </div>
    <div class="card" id="adaptiveCard">
      <div class="card-title">ì ì‘í˜• ì†ë„ ì¡°ì ˆ</div>
      <div class="fw"><div class="fl">ì—°ì† ì •ë‹µ â†’ ì†ë„ ìƒìŠ¹</div>
        <div class="nst"><button class="nb" data-cfg="streakUp" data-d="-1" data-min="1" data-max="10">âˆ’</button><div class="nv" id="val-streakUp">4</div><button class="nb" data-cfg="streakUp" data-d="1" data-min="1" data-max="10">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ì—°ì†</span></div>
      </div>
      <div class="fw" style="margin-bottom:0"><div class="fl">ì—°ì† ì˜¤ë‹µ â†’ ì†ë„ í•˜ë½</div>
        <div class="nst"><button class="nb" data-cfg="streakDown" data-d="-1" data-min="1" data-max="10">âˆ’</button><div class="nv" id="val-streakDown">4</div><button class="nb" data-cfg="streakDown" data-d="1" data-min="1" data-max="10">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ì—°ì†</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ì†ë„ ì„¤ì •</div>
      <div class="fw"><div class="fl">ì‹œì‘ ì†ë„</div>
        <div class="nst"><button class="nb" data-cfg="initSpeed" data-d="-5" data-min="20" data-max="400">âˆ’</button><div class="nv" id="val-initSpeed">90</div><button class="nb" data-cfg="initSpeed" data-d="5" data-min="20" data-max="400">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ms/ê¸€ì</span></div>
        <div class="sd">ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„. ì´ˆê¸‰ 120 Â· ì¤‘ê¸‰ 90 Â· ê³ ê¸‰ 60</div>
      </div>
      <div class="fw" style="margin-bottom:0"><div class="fl">ì†ë„ ë³€í™”ëŸ‰</div>
        <div class="nst"><button class="nb" data-cfg="speedStep" data-d="-1" data-min="1" data-max="50">âˆ’</button><div class="nv" id="val-speedStep">10</div><button class="nb" data-cfg="speedStep" data-d="1" data-min="1" data-max="50">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">%</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">íƒ€ì´ë° ì„¤ì •</div>
      <div class="fw"><div class="fl">ë³´ê¸° ì„ íƒ í›„ ì „í™˜ ë”œë ˆì´</div>
        <div class="nst"><button class="nb" data-cfg="answerDelay" data-d="-100" data-min="0" data-max="3000">âˆ’</button><div class="nv" id="val-answerDelay">500</div><button class="nb" data-cfg="answerDelay" data-d="100" data-min="0" data-max="3000">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ms</span></div>
        <div class="sd">ê°ê´€ì‹ ë‹µ ì„ íƒ í›„ ë‹¤ìŒ ì§€ë¬¸ìœ¼ë¡œ ìë™ ì „í™˜ë˜ê¸°ê¹Œì§€ì˜ ì‹œê°„</div>
      </div>
      <div class="fw" style="margin-bottom:0"><div class="fl">ì§€ë¬¸ ê°„ ë”œë ˆì´</div>
        <div class="nst"><button class="nb" data-cfg="interDelay" data-d="-100" data-min="0" data-max="3000">âˆ’</button><div class="nv" id="val-interDelay">800</div><button class="nb" data-cfg="interDelay" data-d="100" data-min="0" data-max="3000">+</button><span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--dim);margin-left:4px">ms</span></div>
      </div>
    </div>

    <div class="card"><div class="card-title">í´ë” ê´€ë¦¬</div>
      <div id="folderMgr"></div>
      <div class="ar" style="margin-top:7px"><input type="text" id="newFolderName" placeholder="ìƒˆ í´ë” ì´ë¦„"><button class="ab" id="addFolderBtn">+ ì¶”ê°€</button></div>
    </div>
    <div class="card">
      <div class="card-title">ë„ì›€ë§</div>
      <button class="btn-p" id="helpBtn" style="background:var(--sf2);color:var(--tx);border:1px solid var(--bd)">ğŸ“– ì‚¬ìš© ì„¤ëª…ì„œ ë³´ê¸°</button>
    </div>
    <div style="height:32px"></div>
  </div>
</div>

<!-- HELP -->
<div id="help" class="screen">
  <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--bd);flex-shrink:0;gap:10px">
    <button class="btn-g" id="helpBackBtn">â† ë’¤ë¡œ</button>
    <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--ac);letter-spacing:2px">HELP</span>
  </div>
  <div style="flex:1;overflow-y:auto;padding:16px">
    <div class="card">
      <div class="card-title">í”„ë¡œê·¸ë¨ ì†Œê°œ</div>
      <p style="font-size:13px;line-height:1.9;color:var(--tx)">
        ì½ê¸° í›ˆë ¨ê¸°ëŠ” <strong>í…ìŠ¤íŠ¸ í˜ì´ë”©</strong> ê¸°ë²•ì„ í™œìš©í•œ ë…í•´ ì†ë„ ë° ì§‘ì¤‘ë ¥ í›ˆë ¨ ë„êµ¬ì…ë‹ˆë‹¤.<br><br>
        ì§€ë¬¸ì´ ê¸€ì ë‹¨ìœ„ë¡œ ì„œì„œíˆ ì‚¬ë¼ì§€ëŠ” ë™ì•ˆ ë‚´ìš©ì„ ê¸°ì–µí•´ì•¼ í•˜ë©°, ì´í›„ ë¬¸ì œë¥¼ í’€ì–´ ì´í•´ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        Nagler et al. (2015) ì—°êµ¬ì— ê¸°ë°˜í•œ ë°©ì‹ìœ¼ë¡œ, ë°˜ë³µ í›ˆë ¨ì„ í†µí•´ ì½ê¸° ì†ë„ì™€ ì‘ì—… ê¸°ì–µë ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
      </p>
    </div>
    <div class="card">
      <div class="card-title">ì‚¬ìš©ë²•</div>
      <p style="font-size:13px;line-height:2;color:var(--tx)">
        <strong>1. ë¬¸ì œì§‘ ë¶ˆëŸ¬ì˜¤ê¸°</strong><br>
        &nbsp;&nbsp;ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸° íƒ­ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°ë¡œ ë¬¸ì œì§‘ì„ ì¶”ê°€í•©ë‹ˆë‹¤.<br><br>
        <strong>2. í›ˆë ¨ ì‹œì‘</strong><br>
        &nbsp;&nbsp;ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í´ë”ë¥¼ ì—´ê³  â–¶ ë²„íŠ¼ì„ ëˆŒëŸ¬ í›ˆë ¨ì„ ì‹œì‘í•©ë‹ˆë‹¤.<br><br>
        <strong>3. ì§€ë¬¸ ì½ê¸°</strong><br>
        &nbsp;&nbsp;ì§€ë¬¸ì´ í‘œì‹œë˜ë©´ ì½ìœ¼ì„¸ìš”. ê¸€ìëŠ” ì„¤ì •ëœ ì†ë„ì— ë”°ë¼ ì„œì„œíˆ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>
        &nbsp;&nbsp;ëª¨ë‘ ì‚¬ë¼ì§€ë©´ ìë™ìœ¼ë¡œ ë¬¸ì œ í™”ë©´ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.<br><br>
        <strong>4. ë¬¸ì œ í’€ê¸°</strong><br>
        &nbsp;&nbsp;ê°ê´€ì‹: ë³´ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ìˆ«ì í‚¤(1~5)ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë‹¤ìŒ ì§€ë¬¸ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.<br>
        &nbsp;&nbsp;ì£¼ê´€ì‹: ë‹µì„ ì…ë ¥ í›„ ì œì¶œ â†’ ëª¨ë²” ë‹µì•ˆ í™•ì¸ â†’ ì •ì˜¤ë‹µ íŒë‹¨ (í‚¤ë³´ë“œ 1=ì˜¤ë‹µ, 2=ì •ë‹µ)<br><br>
        <strong>5. N-Back ëª¨ë“œ</strong><br>
        &nbsp;&nbsp;ì„¤ì •ì—ì„œ N-Back ëª¨ë“œë¥¼ ì¼œë©´ Në²ˆ ì „ì— ì½ì€ ì§€ë¬¸ì˜ ë¬¸ì œë¥¼ í’€ê²Œ ë©ë‹ˆë‹¤.<br>
        &nbsp;&nbsp;ì‘ì—… ê¸°ì–µë ¥ í›ˆë ¨ì— íš¨ê³¼ì ì…ë‹ˆë‹¤.
      </p>
    </div>
    <div class="card">
      <div class="card-title">í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="help-key-row"><kbd>1</kbd><kbd>2</kbd><kbd>3</kbd><kbd>4</kbd><kbd>5</kbd> <span>ê°ê´€ì‹ ë³´ê¸° ì„ íƒ (ì¼ë°˜/ë„˜íŒ¨ë“œ ìˆ«ì ëª¨ë‘ ì§€ì›)</span></div>
        <div class="help-key-row"><kbd>1</kbd> <span>ì£¼ê´€ì‹ ì±„ì  â€” ì˜¤ë‹µ</span></div>
        <div class="help-key-row"><kbd>2</kbd> <span>ì£¼ê´€ì‹ ì±„ì  â€” ì •ë‹µ</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">JSON í˜•ì‹</div>
      <div class="fl" style="margin-bottom:5px">ê°ê´€ì‹</div>
      <pre style="background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--dim);overflow-x:auto;white-space:pre-wrap;margin-bottom:10px">[{
  "text": "ì§€ë¬¸ ë‚´ìš©",
  "question": "ì§ˆë¬¸?",
  "options": ["ë³´ê¸°1","ë³´ê¸°2","ë³´ê¸°3","ë³´ê¸°4"],
  "answer": 0
}]</pre>
      <div class="fl" style="margin-bottom:5px">ì£¼ê´€ì‹</div>
      <pre style="background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--dim);overflow-x:auto;white-space:pre-wrap">[{
  "text": "ì§€ë¬¸ ë‚´ìš©",
  "question": "ì§ˆë¬¸?",
  "type": "short",
  "answer": "ëª¨ë²” ë‹µì•ˆ"
}]</pre>
    </div>
    <div style="height:32px"></div>
  </div>
</div>


<!-- WB DETAIL -->
<div id="wbDetail" class="screen">
  <div class="dh">
    <button class="btn-g" id="wbBackBtn">â† ë’¤ë¡œ</button>
    <div class="dt" id="wbDetailTitle"></div>
    <button class="btn-ic" id="wbShuffleBtn" title="ì…”í”Œ">ğŸ”€</button>
    <button class="btn-ic" id="wbRenameBtn" title="ì´ë¦„ ë³€ê²½">âœï¸</button>
    <button class="btn-ic" id="wbDeleteBtn" title="ì‚­ì œ">ğŸ—‘</button>
  </div>
  <div style="padding:10px 14px;flex:1;overflow-y:auto"><div id="wbSentList"></div></div>
  <div style="padding:0 14px 22px;flex-shrink:0"><button class="btn-p" id="wbStartBtn">ì´ ë¬¸ì œì§‘ìœ¼ë¡œ í›ˆë ¨ ì‹œì‘ â†’</button></div>
</div>

<!-- TRAINING -->
<div id="training" class="screen">
  <div class="th">
    <div class="tl">
      <div class="tm"><span id="trIdx">0</span>/<span id="trTotal">0</span> Â· <span id="trSpd">-</span>ms/ê¸€ì Â· ì •ë‹µ <span id="trAcc">-</span>%<span id="nbackBadge" style="display:none;margin-left:6px;color:var(--ac)"></span></div>
      <div class="sd-row" id="streakDots"></div>
    </div>
    <button class="btn-g" id="exitBtn">ì¢…ë£Œ</button>
  </div>
  <div class="pb"><div class="pf" id="progFill"></div></div>
  <div class="fa">
    <div class="sw">
      <div class="st" id="sentText"></div>
      <div class="ul" id="sentUl"></div>
    </div>
    <div class="delay-dot" id="delayDot"></div>
  </div>
  <div class="tf">
    <div class="tf-top" id="manualSpeedRow" style="display:none">
      <button class="spd-btn" id="spdSlower">â†“ ëŠë¦¬ê²Œ</button>
      <div class="spd-val" id="spdDisplay">90ms</div>
      <button class="spd-btn" id="spdFaster">â†‘ ë¹ ë¥´ê²Œ</button>
    </div>
    <button class="nxbtn" id="nextBtn">ë‹¤ ì½ì—ˆìŠµë‹ˆë‹¤ â†’</button>
  </div>
</div>

<!-- QUESTION -->
<div id="question" class="screen">
  <div class="qb" style="padding-top:20px">
    <div class="qt" id="qText"></div>
    <!-- ê°ê´€ì‹ ì˜ì—­ -->
    <div class="ow" id="optsWrap">
      <button class="ob" id="opt0"></button>
      <button class="ob" id="opt1"></button>
      <button class="ob" id="opt2"></button>
      <button class="ob" id="opt3"></button>
      <button class="ob" id="opt4" style="display:none"></button>
    </div>
    <!-- ì£¼ê´€ì‹ ì˜ì—­ -->
    <div class="subj-wrap" id="subjWrap" style="display:none">
      <input class="subj-input" id="subjInput" type="text" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
      <button class="subj-submit" id="subjSubmit">ì œì¶œ</button>
      <div class="subj-reveal" id="subjReveal"></div>
      <div class="judge-wrap" id="judgeWrap" style="display:none">
        <button class="judge-btn wrong" id="judgeWrong">âœ— ì˜¤ë‹µ <span class="judge-key">1</span></button>
        <button class="judge-btn correct" id="judgeCorrect">âœ“ ì •ë‹µ <span class="judge-key">2</span></button>
      </div>
    </div>
    <div class="skip-wrap"><button class="skip-btn" id="skipBtn">ëª¨ë¦„ / ê±´ë„ˆëœ€</button></div>
    <div class="qfb" id="qFeedback"></div>
  </div>
  <div class="qft"><button class="qnb" id="qNextBtn">ë‹¤ìŒ ë¬¸ì¥</button></div>
</div>

<!-- RESULT -->
<div id="result" class="screen">
  <div class="re" id="rEmoji">âœ¦</div>
  <div class="rh">ì„¸ì…˜ ì™„ë£Œ!</div>
  <div class="sg">
    <div class="sc2"><div class="sv" id="rSent">0</div><div class="sl2">ì™„ë£Œ ë¬¸ì¥</div></div>
    <div class="sc2"><div class="sv" id="rAcc">0%</div><div class="sl2">ì •ë‹µë¥ </div></div>
    <div class="sc2"><div class="sv" id="rSpeed">0ms</div><div class="sl2">ìµœì¢… ì†ë„</div></div>
    <div class="sc2"><div class="sv" id="rChange">-</div><div class="sl2">ì†ë„ ë³€í™”</div></div>
  </div>
  <div class="rb">
    <button class="rbtn pr" id="retryBtn">ê°™ì€ ì„¸íŠ¸ ë‹¤ì‹œ</button>
    <button class="rbtn se" id="homeBtn">í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="mbg" id="modalBg">
  <div class="md">
    <h3 id="mTitle"></h3>
    <p id="mDesc" style="display:none"></p>
    <input type="text" id="mInput" style="display:none">
    <textarea id="mTextarea" style="display:none;min-height:140px"></textarea>
    <div class="mdb" id="mBtns"></div>
  </div>
</div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import{getAuth,GoogleAuthProvider,signInWithPopup,signOut,onAuthStateChanged}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import{getFirestore,collection,doc,getDocs,setDoc,deleteDoc,updateDoc,query,orderBy}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase ì„¤ì •ì„ ì™¸ë¶€ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
//  ê°™ì€ í´ë”ì— firebase-config.js ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import{firebaseConfig}from'./firebase-config.js';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

// â”€â”€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ â”€â”€
const LS={
  get(k,d){try{const v=localStorage.getItem(k);return v!==null?JSON.parse(v):d}catch{return d}},
  set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}
};

// â”€â”€ í…Œë§ˆ â”€â”€
let theme=LS.get('rfader_theme','dark');
function applyTheme(t){
  const map={dark:'',light:'light',ebook:'ebook'};
  document.documentElement.setAttribute('data-theme',map[t]||'');
  const icons={dark:'â˜€ï¸',light:'ğŸŒ™',ebook:'ğŸ“–'};
  document.getElementById('themeBtn').textContent=icons[t]||'â˜€ï¸';
  theme=t;LS.set('rfader_theme',t);
}
applyTheme(theme);
document.getElementById('themeBtn').addEventListener('click',()=>{
  const order=['dark','light','ebook'];
  const next=order[(order.indexOf(theme)+1)%order.length];
  applyTheme(next);
});

// â”€â”€ CONFIG (ë¡œì»¬ + Firebase /settings ë¬¸ì„œ) â”€â”€
const DCFG={
  provider:'openai',openaiKey:'',geminiKey:'',
  openaiModel:'gpt-4.1-mini',geminiModel:'gemini-2.0-flash',
  openaiModels:['gpt-4.1-mini','gpt-4.1','gpt-4o','gpt-4o-mini','o4-mini','gpt-4.5'],
  geminiModels:['gemini-2.0-flash','gemini-2.5-flash','gemini-2.5-pro','gemini-1.5-flash'],
  topic:'',count:15,charMin:30,charMax:80,extraPrompt:'',wbName:'',lastFolder:'',
  streakUp:4,streakDown:4,speedStep:10,initSpeed:90,
  speedMode:'adaptive',answerDelay:500,interDelay:800,
  savedPrompts:[],
  nbackOn:false,nbackN:2,
};
let CFG={...DCFG,...LS.get('rfader_cfg',{})};

// API í‚¤ëŠ” ë¡œì»¬ì—ë§Œ ë³´ê´€, ë‚˜ë¨¸ì§€ëŠ” Firebaseì—ë„ ì €ì¥
const CLOUD_CFG_KEYS=['provider','openaiModel','geminiModel','openaiModels','geminiModels',
  'topic','count','charMin','charMax','extraPrompt','wbName','lastFolder',
  'streakUp','streakDown','speedStep','initSpeed','speedMode','answerDelay','interDelay','savedPrompts',
  'nbackOn','nbackN'];

function saveCfg(){
  LS.set('rfader_cfg',CFG);
  if(currentUid) saveCloudCfg();
}
async function saveCloudCfg(){
  try{
    const payload={};
    CLOUD_CFG_KEYS.forEach(k=>{if(CFG[k]!==undefined)payload[k]=CFG[k];});
    await setDoc(doc(db,`users/${currentUid}/meta/settings`),payload,{merge:true});
  }catch(e){console.warn('ì„¤ì • ì €ì¥ ì‹¤íŒ¨',e);}
}
async function loadCloudCfg(){
  try{
    const snap=await getDocs(collection(db,`users/${currentUid}/meta`));
    const settingsDoc=snap.docs.find(d=>d.id==='settings');
    if(settingsDoc){
      const data=settingsDoc.data();
      // API í‚¤ëŠ” í´ë¼ìš°ë“œì—ì„œ ë®ì–´ì“°ì§€ ì•ŠìŒ
      const saved={...data};
      delete saved.openaiKey;delete saved.geminiKey;
      CFG={...CFG,...saved};
      LS.set('rfader_cfg',CFG);
    }
  }catch(e){console.warn('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨',e);}
}

// â”€â”€ ì§„í–‰ ìƒíƒœ ì €ì¥ (ì´ì–´í•˜ê¸°) â”€â”€
// {wbId, curIdx, msPerChar, correctCnt, answeredCnt} ì„ Firestore /progress/wbId ì— ì €ì¥
function progressCol(){return`${dbRoot()}/progress`;}
async function saveProgress(wbId,idx,msp,cor,ans){
  if(!wbId) return;
  try{
    await setDoc(doc(db,`${progressCol()}/${wbId}`),{wbId,curIdx:idx,msPerChar:msp,correctCnt:cor,answeredCnt:ans,ts:Date.now()});
  }catch(e){}
}
async function loadProgress(wbId){
  try{
    const snap=await getDocs(collection(db,progressCol()));
    const d=snap.docs.find(d=>d.id===wbId);
    return d?d.data():null;
  }catch{return null;}
}
async function clearProgress(wbId){
  if(!wbId) return;
  try{await deleteDoc(doc(db,`${progressCol()}/${wbId}`));}catch{}
}
// ì§„í–‰ ì¤‘ì¸ ë¬¸ì œì§‘ ID ëª©ë¡
let progressMap={};
async function loadAllProgress(){
  try{
    const snap=await getDocs(collection(db,progressCol()));
    progressMap={};snap.docs.forEach(d=>{progressMap[d.id]=d.data();});
  }catch{}
}

// â”€â”€ Firebase ê²½ë¡œ â”€â”€
let currentUid=null;
function getAnonId(){let id=LS.get('rfader_anon','');if(!id){id='anon_'+Math.random().toString(36).slice(2)+Date.now();LS.set('rfader_anon',id);}return id;}
function dbRoot(){return currentUid?`users/${currentUid}`:`anon/${getAnonId()}`;}
function foldersCol(){return collection(db,`${dbRoot()}/folders`);}
function workbooksCol(){return collection(db,`${dbRoot()}/workbooks`);}
function folderDoc(id){return doc(db,`${dbRoot()}/folders/${id}`);}
function workbookDoc(id){return doc(db,`${dbRoot()}/workbooks/${id}`);}

// â”€â”€ ë™ê¸°í™” ìƒíƒœ â”€â”€
function setSyncState(s){const d=document.getElementById('syncDot');d.className='sync-dot'+(s!=='off'?' '+s:'');}

// â”€â”€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹œ â”€â”€
let libCache={folders:[],workbooks:[]};

async function loadLib(){
  setSyncState('busy');
  try{
    const[fs,ws]=await Promise.all([
      getDocs(query(foldersCol(),orderBy('order','asc'))),
      getDocs(query(workbooksCol(),orderBy('ts','desc')))
    ]);
    libCache.folders=fs.docs.map(d=>({id:d.id,...d.data()}));
    libCache.workbooks=ws.docs.map(d=>({id:d.id,...d.data()}));
    if(!libCache.folders.length) await addFolder('ê¸°ë³¸ í´ë”');
    await loadAllProgress();
    setSyncState('ok');
  }catch(e){setSyncState('err');console.error(e);}
  renderLib();updateFolderSelects();renderFolderMgr();
}

function getLib(){return libCache;}
async function addFolder(name){
  const id='f'+Date.now();
  const data={name,order:libCache.folders.length};
  libCache.folders.push({id,...data});
  await setDoc(folderDoc(id),data);
}
async function renameFolder(id,name){
  libCache.folders=libCache.folders.map(f=>f.id===id?{...f,name}:f);
  setSyncState('busy');await updateDoc(folderDoc(id),{name});setSyncState('ok');
}
async function deleteFolder(id){
  libCache.folders=libCache.folders.filter(f=>f.id!==id);
  const del=libCache.workbooks.filter(w=>w.folderId===id);
  libCache.workbooks=libCache.workbooks.filter(w=>w.folderId!==id);
  setSyncState('busy');
  await deleteDoc(folderDoc(id));
  await Promise.all(del.map(w=>deleteDoc(workbookDoc(w.id))));
  setSyncState('ok');
}
async function addWorkbook(wb){
  libCache.workbooks.unshift(wb);
  setSyncState('busy');await setDoc(workbookDoc(wb.id),wb);setSyncState('ok');
}
async function renameWorkbook(id,name){
  libCache.workbooks=libCache.workbooks.map(w=>w.id===id?{...w,name}:w);
  setSyncState('busy');await updateDoc(workbookDoc(id),{name});setSyncState('ok');
}
async function deleteWorkbook(id){
  libCache.workbooks=libCache.workbooks.filter(w=>w.id!==id);
  setSyncState('busy');await deleteDoc(workbookDoc(id));setSyncState('ok');
}
function getWorkbook(id){return libCache.workbooks.find(w=>w.id===id);}

// â”€â”€ ì…”í”Œ â”€â”€
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
async function shuffleWorkbook(id){
  const wb=getWorkbook(id);if(!wb) return;
  wb.data=shuffle(wb.data);
  libCache.workbooks=libCache.workbooks.map(w=>w.id===id?wb:w);
  setSyncState('busy');await updateDoc(workbookDoc(id),{data:wb.data});setSyncState('ok');
}

// â”€â”€ AUTH â”€â”€
const provider=new GoogleAuthProvider();
document.getElementById('authBtn').addEventListener('click',async()=>{
  if(currentUid){
    if(await confirmDel('ë¡œê·¸ì•„ì›ƒ','ë¹„ë¡œê·¸ì¸ ì„ì‹œ ì €ì¥ì†Œë¡œ ì „í™˜ë©ë‹ˆë‹¤.')){await signOut(auth);}
  }else{
    try{await signInWithPopup(auth,provider);}
    catch(e){showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message.slice(0,40),'');}
  }
});
onAuthStateChanged(auth,async user=>{
  if(user){
    currentUid=user.uid;
    document.getElementById('authInfo').innerHTML=`<span>${user.displayName||user.email}</span> ë¡œê·¸ì¸ë¨`;
    document.getElementById('authBtn').textContent='ë¡œê·¸ì•„ì›ƒ';
    document.getElementById('authBtn').classList.remove('login');
    await loadCloudCfg();
    restoreSettings();
  }else{
    currentUid=null;
    document.getElementById('authInfo').textContent='ë¡œê·¸ì¸í•˜ë©´ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤';
    document.getElementById('authBtn').textContent='Google ë¡œê·¸ì¸';
    document.getElementById('authBtn').classList.add('login');
  }
  await loadLib();
});

// â”€â”€ SCREEN â”€â”€
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â”€â”€ MODAL â”€â”€
let mRes=null;
function openModal({title,desc='',input=false,inputDefault='',inputPlaceholder='',textarea=false,taDefault='',buttons}){
  return new Promise(res=>{
    mRes=res;
    document.getElementById('mTitle').textContent=title;
    const de=document.getElementById('mDesc');de.style.display=desc?'block':'none';de.textContent=desc;
    const inp=document.getElementById('mInput');inp.style.display=input?'block':'none';
    if(input){inp.value=inputDefault;inp.placeholder=inputPlaceholder;setTimeout(()=>inp.focus(),80);}
    const ta=document.getElementById('mTextarea');ta.style.display=textarea?'block':'none';
    if(textarea){ta.value=taDefault;setTimeout(()=>ta.focus(),80);}
    const bb=document.getElementById('mBtns');
    bb.innerHTML=buttons.map((b,i)=>`<button class="${b.cls||''}"data-mi="${i}">${b.label}</button>`).join('');
    bb.querySelectorAll('button').forEach((btn,i)=>{
      btn.addEventListener('click',()=>{
        document.getElementById('modalBg').classList.remove('show');
        if(mRes){const v=input?document.getElementById('mInput').value.trim():textarea?document.getElementById('mTextarea').value.trim():null;mRes({btn:buttons[i].value,val:v});mRes=null;}
      });
    });
    document.getElementById('modalBg').classList.add('show');
  });
}
document.getElementById('mInput').addEventListener('keydown',e=>{if(e.key==='Enter')document.querySelector('#mBtns button:last-child')?.click();});
document.getElementById('modalBg').addEventListener('click',e=>{
  if(e.target===document.getElementById('modalBg')){document.getElementById('modalBg').classList.remove('show');if(mRes){mRes({btn:'cancel',val:null});mRes=null;}}
});
async function confirmDel(name,sub=''){
  const r=await openModal({title:`"${name}" ì‚­ì œ`,desc:sub,buttons:[{label:'ì·¨ì†Œ',cls:'m-cancel',value:'cancel'},{label:'ì‚­ì œ',cls:'m-del',value:'ok'}]});
  return r.btn==='ok';
}
async function promptName(title,def=''){
  const r=await openModal({title,input:true,inputDefault:def,inputPlaceholder:'ì´ë¦„ ì…ë ¥',buttons:[{label:'ì·¨ì†Œ',cls:'m-cancel',value:'cancel'},{label:'í™•ì¸',cls:'m-ok',value:'ok'}]});
  return r.btn==='ok'?r.val:null;
}

// â”€â”€ HOME NAV â”€â”€
document.querySelectorAll('.hnb').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.hnb').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.htab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');document.getElementById('tab-'+b.dataset.nav).classList.add('active');
  });
});

// â”€â”€ LIBRARY RENDER â”€â”€
function renderLib(){
  const lib=getLib(),root=document.getElementById('libRoot');
  if(!lib.folders.length){root.innerHTML='<div class="es">í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  root.innerHTML=lib.folders.map(folder=>{
    const wbs=lib.workbooks.filter(w=>w.folderId===folder.id);
    const wbHtml=wbs.length?wbs.map(wb=>{
      const prog=progressMap[wb.id];
      const pct=prog?Math.round(prog.curIdx/wb.data.length*100):0;
      const resumeBadge=prog&&prog.curIdx>0&&prog.curIdx<wb.data.length
        ?`<span class="resume-badge">${pct}%</span>`:'';
      return`<div class="wi">
        <div class="wi-info" data-wid="${wb.id}">
          <div class="wi-name">${esc(wb.name)}${resumeBadge}</div>
          <div class="wi-meta">${wb.data.length}ë¬¸ì¥ Â· ${new Date(wb.ts).toLocaleDateString('ko')}</div>
        </div>
        <div class="wa">
          <button class="wbtn" data-wr="${wb.id}" title="ì´ë¦„ ë³€ê²½">âœï¸</button>
          <button class="wbtn del" data-wd="${wb.id}" title="ì‚­ì œ">ğŸ—‘</button>
          <button class="wbtn st" data-ws="${wb.id}">â–¶</button>
        </div>
      </div>`;}).join(''):'<div class="es" style="padding:6px 0">ë¬¸ì œì§‘ ì—†ìŒ</div>';
    return`<div class="fs">
      <div class="fhd" data-fid="${folder.id}">
        <span class="fch">â–¶</span><span style="font-size:13px">ğŸ“</span>
        <span class="flb">${esc(folder.name)}</span>
        <span class="fmeta">${wbs.length}ê°œ</span>
        <button class="btn-ic" data-fr="${folder.id}">âœï¸</button>
        <button class="btn-ic" data-fd="${folder.id}">ğŸ—‘</button>
      </div>
      <div class="fb">${wbHtml}</div>
    </div>`;
  }).join('');

  // í´ë” í† ê¸€
  root.querySelectorAll('.fhd').forEach(h=>{
    h.addEventListener('click',e=>{
      if(e.target.closest('.btn-ic')||e.target.closest('.wa')) return;
      h.nextElementSibling.classList.toggle('open');h.querySelector('.fch').classList.toggle('open');
    });
  });
  // í´ë” rename/delete
  root.querySelectorAll('[data-fr]').forEach(b=>b.addEventListener('click',async e=>{
    e.stopPropagation();const f=getLib().folders.find(f=>f.id===b.dataset.fr);
    const n=await promptName('í´ë” ì´ë¦„ ë³€ê²½',f?.name||'');
    if(n){await renameFolder(b.dataset.fr,n);renderLib();updateFolderSelects();renderFolderMgr();}
  }));
  root.querySelectorAll('[data-fd]').forEach(b=>b.addEventListener('click',async e=>{
    e.stopPropagation();
    await deleteFolder(b.dataset.fd);renderLib();updateFolderSelects();renderFolderMgr();
  }));
  // ë¬¸ì œì§‘ rename/delete/start
  root.querySelectorAll('[data-wr]').forEach(b=>b.addEventListener('click',async e=>{
    e.stopPropagation();const wb=getWorkbook(b.dataset.wr);
    const n=await promptName('ë¬¸ì œì§‘ ì´ë¦„ ë³€ê²½',wb?.name||'');
    if(n){await renameWorkbook(b.dataset.wr,n);renderLib();}
  }));
  root.querySelectorAll('[data-wd]').forEach(b=>b.addEventListener('click',async e=>{
    e.stopPropagation();await deleteWorkbook(b.dataset.wd);renderLib();
  }));
  root.querySelectorAll('[data-ws]').forEach(b=>b.addEventListener('click',async e=>{
    e.stopPropagation();await handleStartWorkbook(b.dataset.ws);
  }));
  // ë¬¸ì œì§‘ í´ë¦­ â†’ ìƒì„¸
  root.querySelectorAll('.wi-info[data-wid]').forEach(el=>el.addEventListener('click',()=>openWbDetail(el.dataset.wid)));
}

// â”€â”€ ì´ì–´í•˜ê¸° ì²˜ë¦¬ â”€â”€
async function handleStartWorkbook(wbId){
  const wb=getWorkbook(wbId);if(!wb) return;
  const prog=progressMap[wbId];
  if(prog&&prog.curIdx>0&&prog.curIdx<wb.data.length){
    const r=await openModal({
      title:'ì´ì–´ì„œ ì§„í–‰',
      desc:`${prog.curIdx}/${wb.data.length}ë²ˆì§¸ê¹Œì§€ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ í• ê¹Œìš”?`,
      buttons:[
        {label:'ì²˜ìŒë¶€í„°',cls:'m-cancel',value:'fresh'},
        {label:'ì´ì–´í•˜ê¸°',cls:'m-ok',value:'resume'},
      ]
    });
    if(r.btn==='fresh'){await clearProgress(wbId);startTraining(wb.data,wbId,0,CFG.initSpeed,0,0);}
    else if(r.btn==='resume'){startTraining(wb.data,wbId,prog.curIdx,prog.msPerChar||CFG.initSpeed,prog.correctCnt||0,prog.answeredCnt||0);}
  }else{
    await clearProgress(wbId);
    startTraining(wb.data,wbId,0,CFG.initSpeed,0,0);
  }
}

// â”€â”€ WB DETAIL â”€â”€
let curWbId=null;
function openWbDetail(id){
  curWbId=id;const wb=getWorkbook(id);if(!wb) return;
  document.getElementById('wbDetailTitle').textContent=wb.name;
  document.getElementById('wbSentList').innerHTML=wb.data.map((item,i)=>{
    const isShort=item.type==='short';
    return`<div class="sc-card">
      <div class="scn">#${i+1}<span class="sctype">${isShort?'ì£¼ê´€ì‹':'ê°ê´€ì‹'}</span></div>
      <div class="sct">${esc(item.text)}</div>
      <div class="scq">Q. ${esc(item.question)}</div>
    </div>`;}).join('');
  show('wbDetail');
}
document.getElementById('wbBackBtn').addEventListener('click',()=>{show('home');renderLib();});
document.getElementById('wbShuffleBtn').addEventListener('click',async()=>{
  if(!curWbId) return;
  await shuffleWorkbook(curWbId);
  openWbDetail(curWbId);
  showToast('ë¬¸ì œ ìˆœì„œë¥¼ ì„ì—ˆìŠµë‹ˆë‹¤','up');
});
document.getElementById('wbRenameBtn').addEventListener('click',async()=>{
  const wb=getWorkbook(curWbId);const n=await promptName('ë¬¸ì œì§‘ ì´ë¦„ ë³€ê²½',wb?.name||'');
  if(n){await renameWorkbook(curWbId,n);document.getElementById('wbDetailTitle').textContent=n;}
});
document.getElementById('wbDeleteBtn').addEventListener('click',async()=>{
  const wb=getWorkbook(curWbId);
  if(await confirmDel(wb?.name||'ì´ ë¬¸ì œì§‘')){await deleteWorkbook(curWbId);show('home');renderLib();}
});
document.getElementById('wbStartBtn').addEventListener('click',()=>{if(curWbId)handleStartWorkbook(curWbId);});

// â”€â”€ IMPORT â”€â”€
let importedData=null;
function updateImpFolderSelect(){
  const s=document.getElementById('impFolderSelect');
  s.innerHTML=getLib().folders.map(f=>`<option value="${f.id}">${esc(f.name)}</option>`).join('');
}
function validateImport(data){
  if(!Array.isArray(data)||!data.length) throw new Error('ë°°ì—´ì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
  return data.filter(item=>{
    if(!item.text||!item.question) return false;
    if(item.type==='short') return typeof item.answer==='string'&&item.answer.length>0;
    const ol=item.options?.length;
    return Array.isArray(item.options)&&(ol===4||ol===5)&&typeof item.answer==='number'&&item.answer>=0&&item.answer<ol;
  });
}
function showImportPreview(data){
  importedData=data;
  document.getElementById('impPreviewCard').style.display='block';
  const mc=data.filter(d=>d.type!=='short').length,sc=data.filter(d=>d.type==='short').length;
  document.getElementById('impPreview').innerHTML=`
    <p style="font-size:13px;color:var(--dim);margin-bottom:8px">${data.length}ê°œ (ê°ê´€ì‹ ${mc}ê°œ, ì£¼ê´€ì‹ ${sc}ê°œ)</p>
    ${data.slice(0,3).map((item,i)=>`<div class="sc-card" style="margin-bottom:5px">
      <div class="scn">#${i+1}<span class="sctype">${item.type==='short'?'ì£¼ê´€ì‹':'ê°ê´€ì‹'}</span></div>
      <div class="sct">${esc(item.text.slice(0,60))}${item.text.length>60?'â€¦':''}</div>
    </div>`).join('')}
    ${data.length>3?`<p style="font-size:12px;color:var(--dim);text-align:center;margin-top:4px">ì™¸ ${data.length-3}ê°œ...</p>`:''}`;
}
document.getElementById('importFileBtn').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{try{const d=validateImport(JSON.parse(ev.target.result));if(!d.length)throw new Error('ìœ íš¨í•œ ì§€ë¬¸ ì—†ìŒ');showImportPreview(d);showToast(`${d.length}ê°œ ë¶ˆëŸ¬ì˜´`,'up');}catch(err){showToast('ì˜¤ë¥˜: '+err.message,'');}};
  r.readAsText(file);e.target.value='';
});
document.getElementById('importPasteBtn').addEventListener('click',async()=>{
  const r=await openModal({title:'JSON ë¶™ì—¬ë„£ê¸°',textarea:true,buttons:[{label:'ì·¨ì†Œ',cls:'m-cancel',value:'cancel'},{label:'ë¶ˆëŸ¬ì˜¤ê¸°',cls:'m-ok',value:'ok'}]});
  if(r.btn==='ok'&&r.val){try{const d=validateImport(JSON.parse(r.val));if(!d.length)throw new Error('ìœ íš¨í•œ ì§€ë¬¸ ì—†ìŒ');showImportPreview(d);showToast(`${d.length}ê°œ ë¶ˆëŸ¬ì˜´`,'up');}catch(err){showToast('ì˜¤ë¥˜: '+err.message,'');}}
});
document.getElementById('impSaveBtn').addEventListener('click',async()=>{
  if(!importedData) return;
  const name=document.getElementById('impWbName').value.trim()||'ë¶ˆëŸ¬ì˜¨ ë¬¸ì œì§‘';
  const folderId=document.getElementById('impFolderSelect').value||getLib().folders[0]?.id||'default';
  const wb={id:'wb'+Date.now(),folderId,name,topic:'',ts:Date.now(),data:importedData};
  await addWorkbook(wb);renderLib();
  document.getElementById('impPreviewCard').style.display='none';importedData=null;
  showToast('ì €ì¥ ì™„ë£Œ','up');
  document.querySelectorAll('.hnb').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.htab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-nav="lib"]').classList.add('active');
  document.getElementById('tab-lib').classList.add('active');
});

// â”€â”€ SAVED PROMPTS â”€â”€
document.getElementById('savePromptBtn').addEventListener('click',async()=>{
  const text=document.getElementById('extraPrompt').value.trim();
  if(!text){showToast('ì €ì¥í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','');return;}
  const r=await openModal({title:'í”„ë¡¬í”„íŠ¸ ì €ì¥',input:true,inputPlaceholder:'ì´ë¦„',buttons:[{label:'ì·¨ì†Œ',cls:'m-cancel',value:'cancel'},{label:'ì €ì¥',cls:'m-ok',value:'ok'}]});
  if(r.btn==='ok'&&r.val){const ex=CFG.savedPrompts.find(p=>p.name===r.val);if(ex)ex.text=text;else CFG.savedPrompts.push({name:r.val,text});saveCfg();showToast('ì €ì¥ë¨','up');}
});
document.getElementById('loadPromptBtn').addEventListener('click',async()=>{
  if(!CFG.savedPrompts.length){showToast('ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤','');return;}
  const r=await openModal({
    title:'í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°',
    buttons:[...CFG.savedPrompts.map(p=>({label:p.name,cls:'m-ok',value:'p:'+p.name})),{label:'ì·¨ì†Œ',cls:'m-cancel',value:'cancel'}]
  });
  if(r.btn.startsWith('p:')){const p=CFG.savedPrompts.find(p=>p.name===r.btn.slice(2));if(p){document.getElementById('extraPrompt').value=p.text;CFG.extraPrompt=p.text;saveCfg();showToast(`"${p.name}" ë¶ˆëŸ¬ì˜´`,'up');}}
});

// â”€â”€ SETTINGS â”€â”€
function initSettings(){
  // N-Back í† ê¸€
  const nbackToggle=document.getElementById('nbackToggle');
  const nbackNWrap=document.getElementById('nbackNWrap');
  function updateNBackUI(){
    nbackNWrap.style.display=CFG.nbackOn?'block':'none';
    const el=document.getElementById('nbackDesc');
    if(el) el.textContent=CFG.nbackOn
      ?`${CFG.nbackN}ë²ˆì§¸ ì „ ì§€ë¬¸ì˜ ë¬¸ì œë¥¼ í˜„ì¬ ì§€ë¬¸ í›„ì— í’‰ë‹ˆë‹¤`
      :'í˜„ì¬ ì§€ë¬¸ì´ ì•„ë‹Œ Në²ˆì§¸ ì „ ì§€ë¬¸ì— ëŒ€í•œ ë¬¸ì œë¥¼ í’‰ë‹ˆë‹¤';
  }
  if(nbackToggle){
    nbackToggle.checked=CFG.nbackOn||false;
    nbackToggle.addEventListener('change',()=>{CFG.nbackOn=nbackToggle.checked;saveCfg();updateNBackUI();});
    updateNBackUI();
  }

  // í™”ë©´ ëª¨ë“œ íƒ­
  const themeDescs={dark:'OLED í™”ë©´ì— ìµœì í™”ëœ ì–´ë‘ìš´ ë°°ê²½',light:'ë°ì€ í™˜ê²½ì— ì í•©í•œ ë¼ì´íŠ¸ ëª¨ë“œ',ebook:'ì´ë¶ ë¦¬ë”ê¸°ìš© ê³ ëŒ€ë¹„ í‘ë°± ëª¨ë“œ (ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ)'};
  document.querySelectorAll('[data-tm]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-tm]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      applyTheme(btn.dataset.tm);
      document.getElementById('themeDesc').textContent=themeDescs[btn.dataset.tm]||'';
    });
  });
  document.querySelectorAll('.nb').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const key=btn.dataset.cfg,d=parseInt(btn.dataset.d),min=parseInt(btn.dataset.min??0),max=parseInt(btn.dataset.max??9999);
      CFG[key]=Math.max(min,Math.min(max,(CFG[key]??DCFG[key])+d));
      const el=document.getElementById('val-'+key);if(el)el.textContent=CFG[key];
      saveCfg();
    });
  });
  document.querySelectorAll('[data-sm]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-sm]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');CFG.speedMode=btn.dataset.sm;updateSpeedModeUI();saveCfg();
    });
  });

  renderFolderMgr();
  const folderInp=document.getElementById('newFolderName');
  const doAddFolder=async()=>{
    const n=folderInp.value.trim();if(!n) return;
    setSyncState('busy');
    await addFolder(n);
    setSyncState('ok');
    folderInp.value='';renderFolderMgr();updateFolderSelects();renderLib();
    showToast(`í´ë” "${n}" ìƒì„±ë¨`,'up');
  };
  document.getElementById('addFolderBtn').addEventListener('click',doAddFolder);
  folderInp.addEventListener('keydown',e=>{if(e.key==='Enter')doAddFolder();});
}
function updateSpeedModeUI(){
  const a=CFG.speedMode==='adaptive';
  document.getElementById('adaptiveCard').style.display=a?'block':'none';
  document.getElementById('speedModeDesc').textContent=a?'ì •ë‹µ/ì˜¤ë‹µ ì—°ì†ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤':'í›ˆë ¨ ì¤‘ ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤';
}
function renderFolderMgr(){
  const el=document.getElementById('folderMgr');
  el.innerHTML=getLib().folders.map(f=>`
    <div class="mc" style="margin-bottom:5px">
      <span class="mc-n">ğŸ“ ${esc(f.name)}</span>
      <div style="display:flex;gap:4px">
        <button class="cb" data-fmr="${f.id}" style="font-size:14px">âœï¸</button>
        <button class="cb" data-fmd="${f.id}">âœ•</button>
      </div>
    </div>`).join('');
  el.querySelectorAll('[data-fmr]').forEach(btn=>btn.addEventListener('click',async()=>{
    const f=getLib().folders.find(f=>f.id===btn.dataset.fmr);
    const n=await promptName('í´ë” ì´ë¦„ ë³€ê²½',f?.name||'');
    if(n){await renameFolder(btn.dataset.fmr,n);renderFolderMgr();updateFolderSelects();renderLib();}
  }));
  el.querySelectorAll('[data-fmd]').forEach(btn=>btn.addEventListener('click',async()=>{
    await deleteFolder(btn.dataset.fmd);renderFolderMgr();updateFolderSelects();renderLib();
  }));
}


// â”€â”€ SETTINGS â”€â”€
function initSettings(){
  document.querySelectorAll('.nb').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const key=btn.dataset.cfg,d=parseInt(btn.dataset.d),min=parseInt(btn.dataset.min??0),max=parseInt(btn.dataset.max??9999);
      CFG[key]=Math.max(min,Math.min(max,(CFG[key]??DCFG[key])+d));
      const el=document.getElementById('val-'+key);if(el)el.textContent=CFG[key];
      saveCfg();
    });
  });
  document.querySelectorAll('[data-sm]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-sm]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');CFG.speedMode=btn.dataset.sm;updateSpeedModeUI();saveCfg();
    });
  });
  renderModelLists();
  document.querySelectorAll('.ab[data-provider]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const p=btn.dataset.provider;
      const inp=document.getElementById('add'+p[0].toUpperCase()+p.slice(1)+'Model');
      const v=inp.value.trim();if(!v) return;
      const k=p+'Models';if(!CFG[k].includes(v)){CFG[k].push(v);saveCfg();renderModelLists();updateModelSelect();}
      inp.value='';
    });
  });
  renderFolderMgr();
  const folderInp=document.getElementById('newFolderName');
  const doAddFolder=async()=>{
    const n=folderInp.value.trim();if(!n) return;
    setSyncState('busy');
    await addFolder(n);
    setSyncState('ok');
    folderInp.value='';renderFolderMgr();updateFolderSelects();renderLib();
    showToast(`í´ë” "${n}" ìƒì„±ë¨`,'up');
  };
  document.getElementById('addFolderBtn').addEventListener('click',doAddFolder);
  folderInp.addEventListener('keydown',e=>{if(e.key==='Enter')doAddFolder();});
}
function updateSpeedModeUI(){
  const a=CFG.speedMode==='adaptive';
  document.getElementById('adaptiveCard').style.display=a?'block':'none';
  document.getElementById('speedModeDesc').textContent=a?'ì •ë‹µ/ì˜¤ë‹µ ì—°ì†ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤':'í›ˆë ¨ ì¤‘ ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤';
}
function renderModelLists(){
  ['openai','gemini'].forEach(p=>{
    const el=document.getElementById(p+'ModelList');
    const models=CFG[p+'Models'];
    const def=p==='openai'?['gpt-4.1-mini','gpt-4.1','gpt-4o','gpt-4o-mini','o4-mini','gpt-4.5']:['gemini-2.0-flash','gemini-2.5-flash','gemini-2.5-pro','gemini-1.5-flash'];
    el.innerHTML=models.map(m=>`<div class="mc"><span class="mc-n">${m}</span>${!def.includes(m)?`<button class="cb"data-p="${p}"data-m="${m}">âœ•</button>`:'<span style="color:var(--dim);font-size:10px">ê¸°ë³¸</span>'}</div>`).join('');
    el.querySelectorAll('.cb').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const k=btn.dataset.p+'Models';CFG[k]=CFG[k].filter(m=>m!==btn.dataset.m);
        if(CFG[btn.dataset.p+'Model']===btn.dataset.m)CFG[btn.dataset.p+'Model']=CFG[k][0];
        saveCfg();renderModelLists();updateModelSelect();
      });
    });
  });
}
function renderFolderMgr(){
  const el=document.getElementById('folderMgr');
  el.innerHTML=getLib().folders.map(f=>`
    <div class="mc" style="margin-bottom:5px">
      <span class="mc-n">ğŸ“ ${esc(f.name)}</span>
      <div style="display:flex;gap:4px">
        <button class="cb" data-fmr="${f.id}" style="font-size:14px">âœï¸</button>
        <button class="cb" data-fmd="${f.id}">âœ•</button>
      </div>
    </div>`).join('');
  el.querySelectorAll('[data-fmr]').forEach(btn=>btn.addEventListener('click',async()=>{
    const f=getLib().folders.find(f=>f.id===btn.dataset.fmr);
    const n=await promptName('í´ë” ì´ë¦„ ë³€ê²½',f?.name||'');
    if(n){await renameFolder(btn.dataset.fmr,n);renderFolderMgr();updateFolderSelects();renderLib();}
  }));
  el.querySelectorAll('[data-fmd]').forEach(btn=>btn.addEventListener('click',async()=>{
    await deleteFolder(btn.dataset.fmd);renderFolderMgr();updateFolderSelects();renderLib();
  }));
}

// â”€â”€ NEW FORM â”€â”€
function initNewTab(){
  document.querySelectorAll('[data-p]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-p]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');CFG.provider=btn.dataset.p;saveCfg();updateModelSelect();updateApiKeyField();
    });
  });
  ['topic','count','extraPrompt','wbName','charMin','charMax'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.addEventListener('input',()=>{CFG[id]=el.value;saveCfg();});
  });
  document.getElementById('apiKey').addEventListener('input',()=>{
    const v=document.getElementById('apiKey').value;
    if(CFG.provider==='openai')CFG.openaiKey=v;else CFG.geminiKey=v;saveCfg();
  });
  document.getElementById('modelSelect').addEventListener('change',()=>{
    const v=document.getElementById('modelSelect').value;
    if(CFG.provider==='openai')CFG.openaiModel=v;else CFG.geminiModel=v;saveCfg();
  });
  document.getElementById('folderSelect').addEventListener('change',()=>{CFG.lastFolder=document.getElementById('folderSelect').value;saveCfg();});
}
function updateModelSelect(){
  const sel=document.getElementById('modelSelect'),models=CFG[CFG.provider+'Models'],cur=CFG[CFG.provider+'Model'];
  sel.innerHTML=models.map(m=>`<option value="${m}"${m===cur?' selected':''}>${m}</option>`).join('');
}
function updateApiKeyField(){
  const inp=document.getElementById('apiKey');
  inp.value=CFG.provider==='openai'?(CFG.openaiKey||''):(CFG.geminiKey||'');
  inp.placeholder=CFG.provider==='openai'?'sk-...':'AIza...';
}
function updateFolderSelects(){
  const opts=getLib().folders.map(f=>`<option value="${f.id}">${esc(f.name)}</option>`).join('');
  document.getElementById('impFolderSelect').innerHTML=opts;
}
function restoreSettings(){
  document.querySelectorAll('[data-p]').forEach(b=>b.classList.toggle('active',b.dataset.p===CFG.provider));
  document.querySelectorAll('[data-sm]').forEach(b=>b.classList.toggle('active',b.dataset.sm===CFG.speedMode));
  ['streakUp','streakDown','speedStep','initSpeed','answerDelay','interDelay'].forEach(k=>{
    const el=document.getElementById('val-'+k);if(el)el.textContent=CFG[k];
  });
  updateSpeedModeUI();
  // N-Back ë³µì›
  const nbTog=document.getElementById('nbackToggle');
  if(nbTog){nbTog.checked=CFG.nbackOn||false;}
  const nbNEl=document.getElementById('val-nbackN');if(nbNEl)nbNEl.textContent=CFG.nbackN||2;
  const nbWrap=document.getElementById('nbackNWrap');if(nbWrap)nbWrap.style.display=CFG.nbackOn?'block':'none';
  // í™”ë©´ ëª¨ë“œ íƒ­ ë³µì›
  document.querySelectorAll('[data-tm]').forEach(b=>b.classList.toggle('active',b.dataset.tm===theme));
  const themeDescs2={dark:'OLED í™”ë©´ì— ìµœì í™”ëœ ì–´ë‘ìš´ ë°°ê²½',light:'ë°ì€ í™˜ê²½ì— ì í•©í•œ ë¼ì´íŠ¸ ëª¨ë“œ',ebook:'ì´ë¶ ë¦¬ë”ê¸°ìš© ê³ ëŒ€ë¹„ í‘ë°± ëª¨ë“œ (ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ)'};
  const tdesc=document.getElementById('themeDesc');if(tdesc)tdesc.textContent=themeDescs2[theme]||'';
}


// â”€â”€ TRAINING â”€â”€
const SPEED_MIN=20,SPEED_MAX=400;
let trainingData=[],curIdx=0,msPerChar=90,initMsPerChar=90;
let currentQItem=null; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë¬¸ì œì˜ ì§€ë¬¸ item (N-Back ì§€ì›)
let correctCnt=0,answeredCnt=0,streak=0;
let shortScoreTotal=0,shortScoreMax=0; // ì£¼ê´€ì‹ ìê°€ì±„ì  ëˆ„ì 
let fadingTimer=null,delayTimer=null;
let currentWbId=null;

// N-Back: sentHistory[i]ëŠ” ië²ˆì§¸ê¹Œì§€ í‘œì‹œëœ ì§€ë¬¸ë“¤ì˜ ë°°ì—´
let nbackSentHistory=[];
function startTraining(data,wbId,startIdx,startSpd,cor,ans){
  trainingData=data;curIdx=startIdx;currentWbId=wbId||null;
  msPerChar=startSpd||CFG.initSpeed;initMsPerChar=CFG.initSpeed;
  correctCnt=cor||0;answeredCnt=ans||0;streak=0;
  shortScoreTotal=0;shortScoreMax=0;
  nbackSentHistory=[];
  document.getElementById('manualSpeedRow').style.display=CFG.speedMode==='manual'?'flex':'none';
  updateSpdDisplay();show('training');enterDelay();
}
function updateSpdDisplay(){
  document.getElementById('trSpd').textContent=msPerChar;
  document.getElementById('spdDisplay').textContent=msPerChar+'ms';
}
document.getElementById('spdFaster').addEventListener('click',()=>{
  msPerChar=Math.max(SPEED_MIN,Math.round(msPerChar*(1-CFG.speedStep/100)));updateSpdDisplay();showToast(`â†‘ ë¹ ë¥´ê²Œ â†’ ${msPerChar}ms`,'up');
});
document.getElementById('spdSlower').addEventListener('click',()=>{
  msPerChar=Math.min(SPEED_MAX,Math.round(msPerChar*(1+CFG.speedStep/100)));updateSpdDisplay();showToast(`â†“ ëŠë¦¬ê²Œ â†’ ${msPerChar}ms`,'dn');
});
function enterDelay(){
  clearFading();clearDelayTimer();
  document.getElementById('sentText').innerHTML='';document.getElementById('nextBtn').disabled=true;
  const ul=document.getElementById('sentUl');ul.style.width='60%';ul.className='ul waiting';
  document.getElementById('delayDot').classList.add('show');
  delayTimer=setTimeout(()=>{document.getElementById('delayDot').classList.remove('show');loadSent();},CFG.interDelay);
}
function loadSent(){
  if(curIdx>=trainingData.length){
    // N-Back ëª¨ë“œì—ì„œ ë§ˆì§€ë§‰ ì§€ë¬¸ë“¤ì˜ ë‚¨ì€ ë¬¸ì œ ì²˜ë¦¬
    if(CFG.nbackOn && nbackSentHistory.length < trainingData.length){
      // ê°€ìƒìœ¼ë¡œ curIdxë¥¼ ëŠ˜ë ¤ ë‚¨ì€ nback ë¬¸ì œë“¤ì„ ì¶œì œ
      showQFromHistory();return;
    }
    showResult();return;
  }
  const item=trainingData[curIdx],chars=item.text.split('');
  document.getElementById('trIdx').textContent=curIdx+1;
  document.getElementById('trTotal').textContent=trainingData.length;
  document.getElementById('trAcc').textContent=answeredCnt?Math.round(correctCnt/answeredCnt*100):'-';
  updateSpdDisplay();
  document.getElementById('progFill').style.width=(curIdx/trainingData.length*100)+'%';
  if(CFG.speedMode==='adaptive'){
    const t=Math.max(CFG.streakUp,CFG.streakDown);
    document.getElementById('streakDots').innerHTML=Array.from({length:t},(_,i)=>{
      let c='';if(streak>0&&i<streak)c='hit';else if(streak<0&&i<Math.abs(streak))c='miss';
      return`<div class="sdot ${c}"></div>`;}).join('');
  }else document.getElementById('streakDots').innerHTML='';

  const el=document.getElementById('sentText');
  el.innerHTML=chars.map((c,i)=>`<span class="tok" id="t${i}">${c===' '?'&nbsp;':esc(c)}</span>`).join('');
  const ul=document.getElementById('sentUl');ul.className='ul';
  requestAnimationFrame(()=>{ul.style.width=el.offsetWidth+'px';ul.className='ul active';});
  document.getElementById('nextBtn').disabled=false;
  clearFading();clearDelayTimer();
  // N-Back ë°°ì§€
  const nb=document.getElementById('nbackBadge');
  if(nb){nb.style.display=CFG.nbackOn?'inline':'none';nb.textContent=CFG.nbackOn?`[${CFG.nbackN}-Back]`:'';}
  startFading(chars.length);
}
function startFading(n){
  // ê° ê¸€ì+ê³µë°±ì„ ë™ì¼ ê°„ê²©(msPerChar)ìœ¼ë¡œ ì²˜ë¦¬
  // goingâ†’gone ì „í™˜ì„ ë¶€ë“œëŸ½ê²Œ: CSS transition í™œìš©
  let i=0;
  fadingTimer=setInterval(()=>{
    // ì´ì „ tok ì™„ì „íˆ gone
    if(i>0){
      const p=document.getElementById(`t${i-1}`);
      if(p){p.classList.remove('going');p.classList.add('gone');}
    }
    if(i<n){
      const el=document.getElementById(`t${i}`);
      if(el) el.classList.add('going');
      i++;
    }else{
      clearFading();
      // ëª¨ë‘ ì‚¬ë¼ì§„ í›„ ìë™ìœ¼ë¡œ ë¬¸ì œ ì „í™˜
      setTimeout(()=>showQ(), 120);
    }
  },msPerChar);
}
// N-Back tail: ëª¨ë“  ì§€ë¬¸ ì½ì€ í›„ ë‚¨ì€ N-Back ë¬¸ì œë“¤ ì²˜ë¦¬
function showQFromHistory(){
  // nbackSentHistoryì—ëŠ” trainingData.lengthê°œê°€ ìˆì–´ì•¼ ì™„ë£Œ
  // ì´ í•¨ìˆ˜ëŠ” ëª¨ë“  ì§€ë¬¸ì„ ì½ì€ í›„ ë‚¨ì€ N-1ê°œ ì§ˆë¬¸ì„ ì´ì–´ì„œ ëƒ„
  const pending=trainingData.length - nbackSentHistory.length;
  if(pending <= 0){showResult();return;}
  // ê°€ìƒ push: ì§€ë¬¸ ì—†ì´ íˆìŠ¤í† ë¦¬ë§Œ ì§„í–‰
  nbackSentHistory.push(trainingData.length - pending + nbackSentHistory.length);
  const histLen=nbackSentHistory.length;
  const targetHistPos=histLen-1-CFG.nbackN;
  if(targetHistPos >= 0){
    currentQItem=trainingData[nbackSentHistory[targetHistPos]];
    // ë¬¸ì œ í™”ë©´ í‘œì‹œ
    document.getElementById('qText').textContent=currentQItem.question+` (${CFG.nbackN}ë²ˆ ì „ ì§€ë¬¸)`;
    document.getElementById('qFeedback').className='qfb';
    document.getElementById('qNextBtn').className='qnb';
    document.getElementById('skipBtn').disabled=false;
    const isShort=currentQItem.type==='short';
    document.getElementById('optsWrap').style.display=isShort?'none':'flex';
    document.getElementById('subjWrap').style.display=isShort?'flex':'none';
    if(isShort){
      const inp=document.getElementById('subjInput');inp.value='';inp.disabled=false;
      document.getElementById('subjSubmit').disabled=false;
      document.getElementById('subjReveal').className='subj-reveal';
      document.getElementById('subjReveal').innerHTML='';
      document.getElementById('judgeWrap').className='judge-wrap';
      document.getElementById('judgeWrong').disabled=false;
      document.getElementById('judgeCorrect').disabled=false;
      setTimeout(()=>inp.focus(),100);
    }else{
      const n=currentQItem.options.length;
      [0,1,2,3,4].forEach(i=>{
        const btn=document.getElementById(`opt${i}`);
        if(i<n){btn.textContent=currentQItem.options[i];btn.className='ob';btn.disabled=false;btn.style.display='';btn.onclick=()=>handleMCQ(i,currentQItem.answer,n);}
        else{btn.style.display='none';btn.className='ob';btn.disabled=true;}
      });
    }
    show('question');
  }else{
    showResult();
  }
}
function clearFading(){if(fadingTimer){clearInterval(fadingTimer);fadingTimer=null;}}
function clearDelayTimer(){if(delayTimer){clearTimeout(delayTimer);delayTimer=null;}}

document.getElementById('nextBtn').addEventListener('click',()=>{clearFading();clearDelayTimer();showQ();});
document.getElementById('exitBtn').addEventListener('click',()=>{
  if(currentWbId&&curIdx>0) saveProgress(currentWbId,curIdx,msPerChar,correctCnt,answeredCnt);
  showResult();
});

// â”€â”€ QUESTION â”€â”€
function showQ(){
  // N-Back: ì´ë²ˆì— ë¬¸ì œë¥¼ ë‚¼ ì§€ë¬¸ ê²°ì •
  // nbackSentHistoryì— í˜„ì¬ curIdx ì§€ë¬¸ push (ì§€ë¬¸ ì½ê¸° ì™„ë£Œ ì‹œì )
  nbackSentHistory.push(curIdx);
  // ë¬¸ì œë¥¼ ë‚¼ ì§€ë¬¸ ì¸ë±ìŠ¤: nbackOnì´ë©´ Në²ˆ ì „, ì•„ë‹ˆë©´ í˜„ì¬
  let qItemIdx=curIdx;
  if(CFG.nbackOn){
    const histLen=nbackSentHistory.length;
    const targetHistPos=histLen-1-CFG.nbackN; // Në²ˆ ì „ íˆìŠ¤í† ë¦¬ ìœ„ì¹˜
    if(targetHistPos>=0){
      qItemIdx=nbackSentHistory[targetHistPos];
    }else{
      // ì•„ì§ Në²ˆ ì „ ì§€ë¬¸ì´ ì—†ìœ¼ë©´ ì§€ë¬¸ë§Œ ì½ê³  ë„˜ì–´ê°€ê¸° (ë¬¸ì œ ì—†ì´)
      curIdx++;
      if(currentWbId) saveProgress(currentWbId,curIdx,msPerChar,correctCnt,answeredCnt);
      if(curIdx>=trainingData.length){showResult();return;}
      show('training');enterDelay();return;
    }
  }
  const item=trainingData[qItemIdx];
  currentQItem=item;
  // N-Back ëª¨ë“œë©´ ì–´ëŠ ì§€ë¬¸ ë¬¸ì œì¸ì§€ í‘œì‹œ
  const nbackHint=CFG.nbackOn?` (${CFG.nbackN}ë²ˆ ì „ ì§€ë¬¸)`:'';
  document.getElementById('qText').textContent=item.question+nbackHint;
  document.getElementById('qFeedback').className='qfb';
  document.getElementById('qNextBtn').className='qnb';
  document.getElementById('skipBtn').disabled=false;

  const isShort=item.type==='short';
  document.getElementById('optsWrap').style.display=isShort?'none':'flex';
  document.getElementById('subjWrap').style.display=isShort?'flex':'none';

  if(isShort){
    // ì£¼ê´€ì‹ ì´ˆê¸°í™”
    const inp=document.getElementById('subjInput');
    inp.value='';inp.disabled=false;
    document.getElementById('subjSubmit').disabled=false;
    document.getElementById('subjReveal').className='subj-reveal';
    document.getElementById('subjReveal').innerHTML='';
    document.getElementById('judgeWrap').className='judge-wrap';
    document.getElementById('judgeWrong').disabled=false;
    document.getElementById('judgeCorrect').disabled=false;
    setTimeout(()=>inp.focus(),100);
  }else{
    const n=item.options.length; // 4 or 5
    [0,1,2,3,4].forEach(i=>{
      const btn=document.getElementById(`opt${i}`);
      if(i<n){
        btn.textContent=item.options[i];btn.className='ob';btn.disabled=false;
        btn.style.display='';btn.onclick=()=>handleMCQ(i,item.answer,n);
      }else{
        btn.style.display='none';btn.className='ob';btn.disabled=true;
      }
    });
  }
  show('question');
}

// ì£¼ê´€ì‹ ì œì¶œ
document.getElementById('subjSubmit').addEventListener('click',()=>{
  const item=currentQItem||trainingData[curIdx];
  const userAns=document.getElementById('subjInput').value.trim();
  if(!userAns) return;
  revealShortAnswer(item);
});
document.getElementById('subjInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){document.getElementById('subjSubmit').click();}
});
document.getElementById('judgeWrong').addEventListener('click',()=>handleShortJudge(false));
document.getElementById('judgeCorrect').addEventListener('click',()=>handleShortJudge(true));

// ì œì¶œ í›„ ëª¨ë²” ë‹µì•ˆ ê³µê°œ + ì •ì˜¤ë‹µ ë²„íŠ¼ í‘œì‹œ
function revealShortAnswer(item){
  document.getElementById('subjInput').disabled=true;
  document.getElementById('subjSubmit').disabled=true;
  document.getElementById('skipBtn').disabled=true;
  const reveal=document.getElementById('subjReveal');
  reveal.innerHTML=`ëª¨ë²” ë‹µì•ˆ<br><strong>${esc(item.answer)}</strong>`;
  reveal.className='subj-reveal show';
  document.getElementById('judgeWrap').className='judge-wrap show';
}

// ì •ì˜¤ë‹µ ì„ íƒ â†’ ì¦‰ì‹œ ë‹¤ìŒìœ¼ë¡œ
function handleShortJudge(correct){
  const jw=document.getElementById('judgeWrap');
  document.getElementById('judgeWrong').classList.toggle('chosen-w',!correct);
  document.getElementById('judgeCorrect').classList.toggle('chosen-c',correct);
  document.getElementById('judgeWrong').disabled=true;
  document.getElementById('judgeCorrect').disabled=true;
  answeredCnt++;
  if(correct){correctCnt++;shortScoreTotal+=5;}
  shortScoreMax+=5;
  const fb=document.getElementById('qFeedback');
  fb.textContent=correct?'âœ“ ì •ë‹µ':'âœ— ì˜¤ë‹µ';
  fb.className=correct?'qfb show ok':'qfb show ng';
  if(CFG.speedMode==='adaptive')adaptSpeed(correct,false);
  // ì¦‰ì‹œ ë‹¤ìŒìœ¼ë¡œ
  advanceAfterAnswer();
}

let autoAdvTimer=null;
function advanceAfterAnswer(delay=0){
  if(autoAdvTimer){clearTimeout(autoAdvTimer);autoAdvTimer=null;}
  autoAdvTimer=setTimeout(()=>{
    curIdx++;
    if(currentWbId) saveProgress(currentWbId,curIdx,msPerChar,correctCnt,answeredCnt);
    if(curIdx>=trainingData.length && CFG.nbackOn && nbackSentHistory.length<trainingData.length){
      showQFromHistory();
    }else{
      show('training');enterDelay();
    }
  },delay);
}

function handleMCQ(chosen,correct,n=4){
  const ok=chosen===correct;
  [0,1,2,3,4].forEach(i=>{
    const btn=document.getElementById(`opt${i}`);
    if(i<n){btn.disabled=true;if(i===correct)btn.classList.add('correct');else if(i===chosen&&!ok)btn.classList.add('wrong');}
  });
  document.getElementById('skipBtn').disabled=true;
  answeredCnt++;if(ok)correctCnt++;
  const fb=document.getElementById('qFeedback');
  if(ok){fb.textContent='âœ“ ì •ë‹µì…ë‹ˆë‹¤!';fb.className='qfb show ok';}
  else{fb.textContent=`âœ— ì •ë‹µ: ${(currentQItem||trainingData[curIdx]).options[correct]}`;fb.className='qfb show ng';}
  if(CFG.speedMode==='adaptive')adaptSpeed(ok,false);
  // ìë™ ì „í™˜
  advanceAfterAnswer(CFG.answerDelay||500);
}

document.getElementById('skipBtn').addEventListener('click',()=>{
  const item=currentQItem||trainingData[curIdx];
  const isShort=item.type==='short';
  if(isShort){
    // ì£¼ê´€ì‹ ëª¨ë¦„: ëª¨ë²” ë‹µì•ˆ í‘œì‹œ í›„ 0ì  ì±„ì 
    document.getElementById('subjInput').disabled=true;
    document.getElementById('subjSubmit').disabled=true;
    const reveal=document.getElementById('subjReveal');
    reveal.innerHTML=`ëª¨ë²” ë‹µì•ˆ<br><strong>${esc(item.answer)}</strong>`;
    reveal.className='subj-reveal show';
    document.getElementById('skipBtn').disabled=true;
    answeredCnt++;shortScoreMax+=5; // ì£¼ê´€ì‹ skip = 0ì 
    const fb=document.getElementById('qFeedback');
    fb.textContent='ê±´ë„ˆëœ€';fb.className='qfb show sk';
    if(CFG.speedMode==='adaptive')adaptSpeed(false,true);
    // ëª¨ë²” ë‹µì•ˆ í‘œì‹œ í›„ ì •ì˜¤ë‹µ ë²„íŠ¼ ëŒ€ì‹  ì¦‰ì‹œ ì „í™˜
    advanceAfterAnswer(CFG.answerDelay||500);
  }else{
    const qItem=currentQItem||item;
    const n2=qItem.options?.length||4;
    [0,1,2,3,4].forEach(i=>{const btn=document.getElementById(`opt${i}`);if(i<n2){btn.disabled=true;if(i===qItem.answer)btn.classList.add('correct');}});
    document.getElementById('skipBtn').disabled=true;
    answeredCnt++;
    const fb=document.getElementById('qFeedback');
    fb.textContent=`ê±´ë„ˆëœ€ â€” ì •ë‹µ: ${qItem.options[qItem.answer]}`;
    fb.className='qfb show sk';
    if(CFG.speedMode==='adaptive')adaptSpeed(false,true);
    advanceAfterAnswer(CFG.answerDelay||500);
  }
});

function adaptSpeed(ok,isSkip){
  const correct=ok&&!isSkip;
  if(correct){streak=streak>=0?streak+1:1;}else{streak=streak<=0?streak-1:-1;}
  if(streak>=CFG.streakUp){const n=Math.max(SPEED_MIN,Math.round(msPerChar*(1-CFG.speedStep/100)));if(n<msPerChar){msPerChar=n;updateSpdDisplay();showToast(`âš¡ ${CFG.streakUp}ì—°ì† â†’ ${msPerChar}ms`,'up');}streak=0;}
  if(streak<=-CFG.streakDown){const n=Math.min(SPEED_MAX,Math.round(msPerChar*(1+CFG.speedStep/100)));if(n>msPerChar){msPerChar=n;updateSpdDisplay();showToast(`â†“ ${CFG.streakDown}ì—°ì† ì˜¤ë‹µ â†’ ${msPerChar}ms`,'dn');}streak=0;}
}

document.getElementById('qNextBtn').addEventListener('click',()=>{
  if(autoAdvTimer){clearTimeout(autoAdvTimer);autoAdvTimer=null;}
  advanceAfterAnswer(0);
});

// â”€â”€ RESULT â”€â”€
function showResult(){
  clearFading();clearDelayTimer();
  if(currentWbId&&curIdx>=trainingData.length) clearProgress(currentWbId);
  // MCQ: correctCnt/MCQ answered. Short: shortScoreTotal/shortScoreMax
  // í†µí•© ì •ë‹µë¥ : (MCQ ì •ë‹µ + ì£¼ê´€ì‹ ë¹„ìœ¨*MCQí™˜ì‚°) ìœ¼ë¡œ ë‹¨ìˆœ í‰ê· 
  const mcqAns=answeredCnt-shortScoreMax/5; // MCQ ë‹µë³€ ìˆ˜
  const mcqPts=correctCnt;
  const shortPct=shortScoreMax>0?shortScoreTotal/shortScoreMax:null;
  const mcqPct=mcqAns>0?mcqPts/mcqAns:null;
  let acc=0;
  if(shortPct!==null&&mcqPct!==null) acc=Math.round((shortPct+mcqPct)/2*100);
  else if(shortPct!==null) acc=Math.round(shortPct*100);
  else if(mcqPct!==null) acc=Math.round(mcqPct*100);
  const diff=msPerChar-initMsPerChar;
  document.getElementById('rSent').textContent=curIdx;
  document.getElementById('rAcc').textContent=acc+'%';
  document.getElementById('rSpeed').textContent=msPerChar+'ms';
  document.getElementById('rChange').textContent=diff<0?`${diff}ms â†‘ë¹ ë¦„`:diff>0?`+${diff}ms â†“ëŠë¦¼`:'ìœ ì§€';
  document.getElementById('rEmoji').textContent=acc>=80?'ğŸ†':acc>=60?'âœ¦':'ğŸ’ª';
  show('result');
}
document.getElementById('retryBtn').addEventListener('click',()=>startTraining(trainingData,currentWbId,0,CFG.initSpeed,0,0));
document.getElementById('homeBtn').addEventListener('click',async()=>{
  clearFading();clearDelayTimer();
  await loadAllProgress();
  show('home');renderLib();
});

// â”€â”€ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ â”€â”€
document.addEventListener('keydown',e=>{
  // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì¤‘ì—” ë‹¨ì¶•í‚¤ ë¹„í™œì„±
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
  
  // ìˆ«ì í‚¤ íŒë³„ (ì¼ë°˜ + ë„˜íŒ¨ë“œ)
  let num=null;
  if(e.code>='Digit1'&&e.code<='Digit5') num=parseInt(e.code.slice(5));
  else if(e.code>='Numpad1'&&e.code<='Numpad5') num=parseInt(e.code.slice(6));
  if(num===null) return;

  const qScreen=document.getElementById('question');
  if(!qScreen.classList.contains('active')) return;

  const isShort=document.getElementById('subjWrap').style.display!=='none';

  if(isShort){
    // ì£¼ê´€ì‹ ì±„ì  ë‹¨ê³„: 1=ì˜¤ë‹µ, 2=ì •ë‹µ
    const jw=document.getElementById('judgeWrap');
    if(jw.classList.contains('show')){
      if(num===1) handleShortJudge(false);
      else if(num===2) handleShortJudge(true);
    }
  }else{
    // ê°ê´€ì‹: 1~5ë²ˆ ë³´ê¸° ì„ íƒ
    const idx=num-1;
    const btn=document.getElementById(`opt${idx}`);
    if(btn&&!btn.disabled&&btn.style.display!=='none'&&btn.textContent){
      btn.click();
    }
  }
});

// â”€â”€ TOAST â”€â”€
let tTimer=null;
function showToast(msg,type){
  const el=document.getElementById('toast');el.textContent=msg;el.className='toast show '+(type||'');
  if(tTimer)clearTimeout(tTimer);tTimer=setTimeout(()=>el.classList.remove('show'),2200);
}

// â”€â”€ HELP â”€â”€
document.getElementById('helpBtn').addEventListener('click',()=>show('help'));
document.getElementById('helpBackBtn').addEventListener('click',()=>show('home'));

// â”€â”€ INIT â”€â”€
window.addEventListener('DOMContentLoaded',()=>{
  initSettings();restoreSettings();
  // loadLibì€ onAuthStateChangedì—ì„œ ìë™ í˜¸ì¶œ
});
</script>
</body>
</html>
